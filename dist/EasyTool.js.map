{"version":3,"sources":["../src/EasyTool.js"],"names":["EasyTool","constructor","toolName","log","options","debug","_ensureCommands","cmds","Set","forEach","cmd","has","Error","add","_execAndCapture","command","Promise","resolve","reject","cp","output","stdout","on","data","toString","error","code","_getPackageInfo","filenames","ignore","realpath","dirNames","map","filename","path","dirname","pkgMap","Map","dirName","edges","rootPkg","pair","pkg","packageFilename","content","JSON","parse","encoding","process","cwd","dependencies","prefix","Object","entries","arr","startsWith","otherdirName","join","substring","length","push","pkgs","order","toposort","array","reverse","_execAndLog","re","RegExp","s","replace","ansible","ansibleOK","ansibleChanged","ansibleSkipping","ansibleError","info","stderr","_test","pkgInfo","get","scripts","test","info2","basename","_clean","name","_install","clean","_build","install","build","_deploy","deploy","_checkForUncommittedChanges","_getCurrentBranch","branch","trim","_release","version","incrFlag","tagName","tagDescription","suffix","isNewTag","_rollback","lastTag","penultimateTag","_recurse","commands","operation","apply","startAll","tmpObjMain","tmp","fileSync","tmpObjHelper","script","firstTab","tabDetails","preferActors","actorNames","getOwnPropertyNames","filter","endsWith","title","color","start","isLibrary","keywords","Array","isArray","includes","hasOwnProperty","detail","shell","testAll","cleanAll","installAll","buildAll","releaseAll","deployAll","rollbackAll","run","argv","boolean","string","alias","a","args","fullVersion","_","toLowerCase","shift","help","actors"],"mappings":";;;;;;;AAAA;;AACA;;AACA;;AACA;;AACA;;AACA;;AACA;;AACA;;AACA;;AACA;;;;AAEO,MAAMA,QAAN,CAAe;AACpBC,EAAAA,WAAW,CAACC,QAAD,EAAWC,GAAX,EAAgBC,OAAhB,EAAyB;AAClCA,IAAAA,OAAO,GAAGA,OAAO,IAAI,EAArB;AACA,SAAKF,QAAL,GAAgBA,QAAhB;AACA,SAAKC,GAAL,GAAWA,GAAX;AACA,SAAKE,KAAL,GAAaD,OAAO,CAACC,KAArB;AACD;;AAEDC,EAAAA,eAAe,CAACC,IAAD,EAAO;AACpB,SAAKA,IAAL,GAAY,KAAKA,IAAL,IAAa,IAAIC,GAAJ,EAAzB;AAEAD,IAAAA,IAAI,CAACE,OAAL,CAAcC,GAAD,IAAS;AACpB,UAAI,CAAC,KAAKH,IAAL,CAAUI,GAAV,CAAcD,GAAd,CAAD,IAAuB,CAAC,yBAAkBA,GAAlB,CAA5B,EAAoD;AAClD,cAAM,IAAIE,KAAJ,CAAW,YAAWF,GAAI,uCAA1B,CAAN;AACD,OAFD,MAEO;AACL,aAAKH,IAAL,CAAUM,GAAV,CAAcH,GAAd;AACD;AACF,KAND;AAOD;;AAEDI,EAAAA,eAAe,CAACC,OAAD,EAAUX,OAAV,EAAmB;AAChC,WAAO,IAAIY,OAAJ,CAAY,CAACC,OAAD,EAAUC,MAAV,KAAqB;AACtC,YAAMC,EAAE,GAAG,yBAAKJ,OAAL,EAAcX,OAAd,CAAX;AACA,UAAIgB,MAAM,GAAG,EAAb;AAEAD,MAAAA,EAAE,CAACE,MAAH,CAAUC,EAAV,CAAa,MAAb,EAAsBC,IAAD,IAAU;AAC7BH,QAAAA,MAAM,IAAIG,IAAI,CAACC,QAAL,EAAV;AACD,OAFD;AAIAL,MAAAA,EAAE,CAACG,EAAH,CAAM,OAAN,EAAgBG,KAAD,IAAW;AACxBP,QAAAA,MAAM,CAACO,KAAD,CAAN;AACD,OAFD;AAIAN,MAAAA,EAAE,CAACG,EAAH,CAAM,MAAN,EAAc,UAASI,IAAT,EAAe;AAC3B,YAAIA,IAAI,KAAK,CAAb,EAAgB;AACdR,UAAAA,MAAM,CAAC,IAAIN,KAAJ,CAAU,oBAAV,CAAD,CAAN;AACD,SAFD,MAEO;AACLK,UAAAA,OAAO,CAACG,MAAD,CAAP;AACD;AACF,OAND;AAOD,KAnBM,CAAP;AAoBD;;AAED,QAAMO,eAAN,GAAwB;AACtB,QAAI,EAAE,MAAM,qBAAO,cAAP,CAAR,CAAJ,EAAqC;AACnC,YAAM,IAAIf,KAAJ,CACJ,4DADI,CAAN;AAGD;;AAED,UAAMgB,SAAS,GAAG,gBAAS,iBAAT,EAA4B;AAC5CC,MAAAA,MAAM,EAAE,CAAC,oBAAD,EAAuB,eAAvB,CADoC;AAE5CC,MAAAA,QAAQ,EAAE;AAFkC,KAA5B,CAAlB;AAIA,UAAMC,QAAQ,GAAGH,SAAS,CAACI,GAAV,CAAeC,QAAD,IAAcC,cAAKC,OAAL,CAAaF,QAAb,CAA5B,CAAjB;AACA,UAAMG,MAAM,GAAG,IAAIC,GAAJ,CAAQN,QAAQ,CAACC,GAAT,CAAcM,OAAD,IAAa,CAACA,OAAD,EAAU,EAAV,CAA1B,CAAR,CAAf;AACA,QAAIC,KAAK,GAAG,EAAZ;AACA,QAAIC,OAAO,GAAG,IAAd;;AAEA,SAAK,IAAIC,IAAT,IAAiBL,MAAjB,EAAyB;AACvB,YAAM,CAACE,OAAD,EAAUI,GAAV,IAAiBD,IAAvB;AACA,YAAME,eAAe,GAAGL,OAAO,GAAG,eAAlC;AACA,UAAIM,OAAO,GAAG,IAAd;;AAEA,UAAI;AACFA,QAAAA,OAAO,GAAGC,IAAI,CAACC,KAAL,EACR,MAAM,uBAASH,eAAT,EAA0B;AAAEI,UAAAA,QAAQ,EAAE;AAAZ,SAA1B,CADE,EAAV;AAGD,OAJD,CAIE,OAAOtB,KAAP,EAAc;AACd,aAAKtB,GAAL,CAASsB,KAAT,CAAgB,WAAUkB,eAAgB,EAA1C;AACA,cAAMlB,KAAN;AACD;;AAEDiB,MAAAA,GAAG,CAACE,OAAJ,GAAcA,OAAd;;AAEA,UAAIN,OAAO,KAAKU,iBAAQC,GAAR,EAAhB,EAA+B;AAC7BT,QAAAA,OAAO,GAAGE,GAAV;AACD,OAFD,MAEO,IAAIE,OAAO,CAACM,YAAZ,EAA0B;AAC/B,cAAMC,MAAM,GAAG,OAAf;AAEAC,QAAAA,MAAM,CAACC,OAAP,CAAeT,OAAO,CAACM,YAAvB,EAAqCzC,OAArC,CAA8C6C,GAAD,IAAS;AACpD,cAAIA,GAAG,CAAC,CAAD,CAAH,CAAOC,UAAP,CAAkBJ,MAAlB,CAAJ,EAA+B;AAC7B,kBAAMK,YAAY,GAAGtB,cAAKjB,OAAL,CACnBiB,cAAKuB,IAAL,CAAUnB,OAAV,EAAmBgB,GAAG,CAAC,CAAD,CAAH,CAAOI,SAAP,CAAiBP,MAAM,CAACQ,MAAxB,CAAnB,CADmB,CAArB;;AAIA,gBAAIvB,MAAM,CAACzB,GAAP,CAAW6C,YAAX,CAAJ,EAA8B;AAC5BjB,cAAAA,KAAK,CAACqB,IAAN,CAAW,CAACtB,OAAD,EAAUkB,YAAV,CAAX;AACD;AACF;AACF,SAVD;AAWD;AACF;;AAED,WAAO;AACLK,MAAAA,IAAI,EAAEzB,MADD;AAEL0B,MAAAA,KAAK,EAAEC,kBAASC,KAAT,CAAejC,QAAf,EAAyBQ,KAAzB,EAAgC0B,OAAhC,EAFF;AAGLzB,MAAAA;AAHK,KAAP;AAKD;;AAED0B,EAAAA,WAAW,CAACnD,OAAD,EAAUX,OAAO,GAAG,EAApB,EAAwB;AACjC,WAAO,IAAIY,OAAJ,CAAY,CAACC,OAAD,EAAUC,MAAV,KAAqB;AACtC,YAAMC,EAAE,GAAG,yBAAKJ,OAAL,EAAcX,OAAd,CAAX;AACA,YAAM+D,EAAE,GAAG,IAAIC,MAAJ,CAAW,KAAX,CAAX;AAEAjD,MAAAA,EAAE,CAACE,MAAH,CAAUC,EAAV,CAAa,MAAb,EAAsBC,IAAD,IAAU;AAC7B,cAAM8C,CAAC,GAAG9C,IAAI,CAACC,QAAL,GAAgB8C,OAAhB,CAAwBH,EAAxB,EAA4B,EAA5B,CAAV;;AAEA,YAAI/D,OAAO,CAACmE,OAAZ,EAAqB;AACnB,cAAIF,CAAC,CAACd,UAAF,CAAa,MAAb,CAAJ,EAA0B;AACxB,iBAAKpD,GAAL,CAASqE,SAAT,CAAmBH,CAAnB;AACD,WAFD,MAEO,IAAIA,CAAC,CAACd,UAAF,CAAa,WAAb,CAAJ,EAA+B;AACpC,iBAAKpD,GAAL,CAASsE,cAAT,CAAwBJ,CAAxB;AACD,WAFM,MAEA,IAAIA,CAAC,CAACd,UAAF,CAAa,YAAb,CAAJ,EAAgC;AACrC,iBAAKpD,GAAL,CAASuE,eAAT,CAAyBL,CAAzB;AACD,WAFM,MAEA,IAAIA,CAAC,CAACd,UAAF,CAAa,SAAb,CAAJ,EAA6B;AAClC,iBAAKpD,GAAL,CAASwE,YAAT,CAAsBN,CAAtB;AACD,WAFM,MAEA;AACL,iBAAKlE,GAAL,CAASyE,IAAT,CAAcP,CAAd;AACD;AACF,SAZD,MAYO;AACL,eAAKlE,GAAL,CAASyE,IAAT,CAAcP,CAAd;AACD;AACF,OAlBD;AAoBAlD,MAAAA,EAAE,CAAC0D,MAAH,CAAUvD,EAAV,CAAa,MAAb,EAAsBC,IAAD,IAAU;AAC7B,cAAM8C,CAAC,GAAG9C,IAAI,CAACC,QAAL,GAAgB8C,OAAhB,CAAwBH,EAAxB,EAA4B,EAA5B,CAAV;;AAEA,YAAIE,CAAC,KAAK,KAAN,IAAeA,CAAC,KAAK,QAArB,IAAiCA,CAAC,KAAK,YAA3C,EAAyD;AACvD,eAAKlE,GAAL,CAASyE,IAAT,CAAcP,CAAd;AACD;AACF,OAND;AAQAlD,MAAAA,EAAE,CAACG,EAAH,CAAM,OAAN,EAAgBG,KAAD,IAAW;AACxBP,QAAAA,MAAM,CAACO,KAAD,CAAN;AACD,OAFD;AAIAN,MAAAA,EAAE,CAACG,EAAH,CAAM,MAAN,EAAc,UAASI,IAAT,EAAe;AAC3B,YAAIA,IAAI,KAAK,CAAb,EAAgB;AACdR,UAAAA,MAAM,CAAC,IAAIN,KAAJ,CAAU,oBAAV,CAAD,CAAN;AACD,SAFD,MAEO;AACLK,UAAAA,OAAO;AACR;AACF,OAND;AAOD,KA3CM,CAAP;AA4CD;;AAEDH,EAAAA,eAAe,CAACC,OAAD,EAAUX,OAAV,EAAmB;AAChC,WAAO,IAAIY,OAAJ,CAAY,CAACC,OAAD,EAAUC,MAAV,KAAqB;AACtC,YAAMC,EAAE,GAAG,yBAAKJ,OAAL,EAAcX,OAAd,CAAX;AACA,UAAIgB,MAAM,GAAG,EAAb;AAEAD,MAAAA,EAAE,CAACE,MAAH,CAAUC,EAAV,CAAa,MAAb,EAAsBC,IAAD,IAAU;AAC7BH,QAAAA,MAAM,IAAIG,IAAI,CAACC,QAAL,EAAV;AACD,OAFD;AAIAL,MAAAA,EAAE,CAACG,EAAH,CAAM,OAAN,EAAgBG,KAAD,IAAW;AACxBP,QAAAA,MAAM,CAACO,KAAD,CAAN;AACD,OAFD;AAIAN,MAAAA,EAAE,CAACG,EAAH,CAAM,MAAN,EAAc,UAASI,IAAT,EAAe;AAC3B,YAAIA,IAAI,KAAK,CAAb,EAAgB;AACdR,UAAAA,MAAM,CAAC,IAAIN,KAAJ,CAAU,oBAAV,CAAD,CAAN;AACD,SAFD,MAEO;AACLK,UAAAA,OAAO,CAACG,MAAD,CAAP;AACD;AACF,OAND;AAOD,KAnBM,CAAP;AAoBD;;AAED,QAAM0D,KAAN,CAAYxC,OAAZ,EAAqB;AACnB,UAAMI,GAAG,GAAG,KAAKqC,OAAL,CAAalB,IAAb,CAAkBmB,GAAlB,CAAsB1C,OAAtB,CAAZ;;AAEA,QAAII,GAAG,CAACE,OAAJ,CAAYqC,OAAZ,IAAuBvC,GAAG,CAACE,OAAJ,CAAYqC,OAAZ,CAAoBC,IAA/C,EAAqD;AACnD,WAAK/E,GAAL,CAASgF,KAAT,CAAgB,YAAWjD,cAAKkD,QAAL,CAAc9C,OAAd,CAAuB,MAAlD;AACA,YAAM,KAAK4B,WAAL,CAAkB,UAAlB,EAA6B;AAAEjB,QAAAA,GAAG,EAAEX;AAAP,OAA7B,CAAN;AACD;AACF;;AAED,QAAM+C,MAAN,CAAa/C,OAAb,EAAsB;AACpB,UAAMgD,IAAI,GAAGpD,cAAKkD,QAAL,CAAc9C,OAAd,CAAb;;AAEA,SAAKnC,GAAL,CAASgF,KAAT,CAAgB,aAAYG,IAAK,MAAjC;AACA,UAAM,qBAAOpD,cAAKuB,IAAL,CAAUnB,OAAV,EAAmB,cAAnB,CAAP,CAAN;AACA,UAAM,qBAAOJ,cAAKuB,IAAL,CAAUnB,OAAV,EAAmB,mBAAnB,CAAP,CAAN;AACA,UAAM,qBAAOJ,cAAKuB,IAAL,CAAUnB,OAAV,EAAmB,MAAnB,CAAP,CAAN;AACA,UAAM,qBAAOJ,cAAKuB,IAAL,CAAUnB,OAAV,EAAmB,OAAnB,CAAP,CAAN;AACD;;AAED,QAAMiD,QAAN,CAAejD,OAAf,EAAwBlC,OAAO,GAAG,EAAlC,EAAsC;AACpC,UAAMkF,IAAI,GAAGpD,cAAKkD,QAAL,CAAc9C,OAAd,CAAb;;AAEA,QAAIlC,OAAO,CAACoF,KAAZ,EAAmB;AACjB,YAAM,KAAKH,MAAL,CAAY/C,OAAZ,CAAN;AACD;;AAED,SAAKnC,GAAL,CAASgF,KAAT,CAAgB,0BAAyBG,IAAK,MAA9C;AACA,UAAM,KAAKpB,WAAL,CAAkB,aAAlB,EAAgC;AAAEjB,MAAAA,GAAG,EAAEX;AAAP,KAAhC,CAAN;AACD;;AAED,QAAMmD,MAAN,CAAanD,OAAb,EAAsBlC,OAAO,GAAG,EAAhC,EAAoC;AAClC,UAAMsC,GAAG,GAAG,KAAKqC,OAAL,CAAalB,IAAb,CAAkBmB,GAAlB,CAAsB1C,OAAtB,CAAZ;;AACA,UAAMgD,IAAI,GAAGpD,cAAKkD,QAAL,CAAc9C,OAAd,CAAb;;AAEA,QAAIlC,OAAO,CAACsF,OAAZ,EAAqB;AACnB,YAAM,KAAKH,QAAL,CAAcjD,OAAd,CAAN;AACD;;AAED,QAAII,GAAG,CAACE,OAAJ,CAAYqC,OAAZ,IAAuBvC,GAAG,CAACE,OAAJ,CAAYqC,OAAZ,CAAoBU,KAA/C,EAAsD;AACpD,WAAKxF,GAAL,CAASgF,KAAT,CAAgB,aAAYG,IAAK,MAAjC;AACA,YAAM,KAAKpB,WAAL,CAAiB,eAAjB,EAAkC;AAAEjB,QAAAA,GAAG,EAAEX;AAAP,OAAlC,CAAN;AACD;AACF;;AAED,QAAMsD,OAAN,CAActD,OAAd,EAAuB;AACrB,UAAMI,GAAG,GAAG,KAAKqC,OAAL,CAAalB,IAAb,CAAkBmB,GAAlB,CAAsB1C,OAAtB,CAAZ;;AACA,UAAMgD,IAAI,GAAGpD,cAAKkD,QAAL,CAAc9C,OAAd,CAAb;;AAEA,QAAII,GAAG,CAACE,OAAJ,CAAYqC,OAAZ,IAAuBvC,GAAG,CAACE,OAAJ,CAAYqC,OAAZ,CAAoBY,MAA/C,EAAuD;AACrD,WAAK1F,GAAL,CAASgF,KAAT,CAAgB,cAAaG,IAAK,MAAlC;AACA,YAAM,KAAKpB,WAAL,CAAiB,gBAAjB,EAAmC;AACvCjB,QAAAA,GAAG,EAAEX,OADkC;AAEvCiC,QAAAA,OAAO,EAAE;AAF8B,OAAnC,CAAN;AAID;AACF;;AAED,QAAMuB,2BAAN,GAAoC;AAClC,SAAK3F,GAAL,CAASgF,KAAT,CAAe,qCAAf;;AACA,QAAI;AACF,YAAM,KAAKjB,WAAL,CAAiB,gCAAjB,CAAN;AACD,KAFD,CAEE,OAAOzC,KAAP,EAAc;AACd,YAAM,IAAIb,KAAJ,CACJ,mEADI,CAAN;AAGD;AACF;;AAED,QAAMmF,iBAAN,GAA0B;AACxB,QAAIC,MAAM,GAAG,CAAC,MAAM,KAAKlF,eAAL,CAClB,iCADkB,CAAP,EAEVmF,IAFU,EAAb;;AAIA,QAAID,MAAM,KAAK,MAAf,EAAuB;AACrBA,MAAAA,MAAM,GAAG,QAAT;AACD;;AAED,WAAOA,MAAP;AACD;;AAED,QAAME,QAAN,CAAe5D,OAAf,EAAwBlC,OAAO,GAAG,EAAlC,EAAsC;AACpC,QACEA,OAAO,CAAC+F,OAAR,KAAoB,OAApB,IACA/F,OAAO,CAAC+F,OAAR,KAAoB,OADpB,IAEA/F,OAAO,CAAC+F,OAAR,KAAoB,OAFpB,IAGA/F,OAAO,CAAC+F,OAAR,KAAoB,UAJtB,EAKE;AACA,YAAM,IAAIvF,KAAJ,CACH,iEADG,CAAN;AAGD;;AAED,UAAM,KAAKkF,2BAAL,EAAN;AAEA,UAAME,MAAM,GAAG5F,OAAO,CAAC4F,MAAR,KAAmB,MAAM,KAAKD,iBAAL,EAAzB,CAAf;;AACA,UAAMT,IAAI,GAAGpD,cAAKkD,QAAL,CAAc9C,OAAd,CAAb;;AAEA,SAAKnC,GAAL,CAASgF,KAAT,CAAgB,wBAAuBG,IAAK,gBAAeU,MAAO,MAAlE;AACA,SAAK7F,GAAL,CAASgF,KAAT,CAAgB,iBAAgBa,MAAO,MAAvC;AACA,UAAM,KAAK9B,WAAL,CAAkB,gBAAe8B,MAAO,EAAxC,CAAN;AACA,SAAK7F,GAAL,CAASgF,KAAT,CAAe,mBAAf;AACA,UAAM,KAAKjB,WAAL,CAAiB,UAAjB,CAAN;AACA,SAAK/D,GAAL,CAASgF,KAAT,CAAe,qBAAf;AACA,UAAM,wBAAU,SAAV,CAAN;AAEA,UAAMiB,QAAQ,GACZhG,OAAO,CAAC+F,OAAR,KAAoB,OAApB,GACI,UADJ,GAEI/F,OAAO,CAAC+F,OAAR,KAAoB,OAApB,GACA,UADA,GAEA/F,OAAO,CAAC+F,OAAR,KAAoB,OAApB,GACA,UADA,GAEA,EAPN;AASA,UAAM,KAAKjC,WAAL,CAAkB,gBAAekC,QAAS,QAA1C,CAAN;AAEA,QAAIC,OAAO,GAAG,MAAM,uBAAS,yBAAT,CAApB;AACA,QAAIC,cAAc,GAAG,MAAM,uBAAS,0BAAT,CAA3B;;AAEA,QAAIN,MAAM,KAAK,QAAf,EAAyB;AACvB,YAAMO,MAAM,GAAG,MAAMP,MAArB;AAEAK,MAAAA,OAAO,IAAIE,MAAX;AACAD,MAAAA,cAAc,IAAIC,MAAlB;AACD;;AAED,QAAIC,QAAQ,GAAG,IAAf;;AACA,QAAI;AACF,YAAM,KAAK1F,eAAL,CAAsB,iBAAgBuF,OAAQ,EAA9C,CAAN;AACAG,MAAAA,QAAQ,GAAG,KAAX;AACD,KAHD,CAGE,OAAO/E,KAAP,EAAc;AACd,WAAKtB,GAAL,CAASyE,IAAT,CAAe,mBAAkByB,OAAQ,gBAAzC;AACD;;AAED,QAAI,CAACG,QAAL,EAAe;AACb,YAAM,KAAKtC,WAAL,CAAkB,gBAAe8B,MAAO,IAAxC,CAAN;AACA,YAAM,IAAIpF,KAAJ,CACJ,2DADI,CAAN;AAGD;;AAED,QAAI;AACF,UAAIR,OAAO,CAACoF,KAAZ,EAAmB;AACjB,cAAM,KAAKH,MAAL,CAAY/C,OAAZ,CAAN;AACD;;AACD,YAAM,KAAKiD,QAAL,CAAcjD,OAAd,CAAN;AACA,YAAM,KAAKmD,MAAL,CAAYnD,OAAZ,CAAN;AACA,YAAM,KAAKwC,KAAL,CAAWxC,OAAX,CAAN;AACD,KAPD,CAOE,OAAOb,KAAP,EAAc;AACd;AACA,YAAM,KAAKyC,WAAL,CAAkB,gBAAe8B,MAAO,IAAxC,CAAN;AACA,YAAM,IAAIpF,KAAJ,CAAW,mBAAkB0E,IAAK,eAAcU,MAAO,GAAvD,CAAN;AACD;;AAED,SAAK7F,GAAL,CAASgF,KAAT,CAAe,4BAAf;AACA,UAAM,KAAKjB,WAAL,CAAiB,YAAjB,CAAN;AACA,SAAK/D,GAAL,CAASyE,IAAT,CAAc,+BAAd;AACA,UAAM,KAAKV,WAAL,CAAkB,kBAAiBoC,cAAe,GAAlD,CAAN;AAEA,SAAKnG,GAAL,CAASgF,KAAT,CAAe,YAAf;AACA,UAAM,KAAKjB,WAAL,CAAkB,eAAcmC,OAAQ,SAAQC,cAAe,GAA/D,CAAN;AACA,SAAKnG,GAAL,CAASgF,KAAT,CAAe,mBAAf;AACA,UAAM,KAAKjB,WAAL,CAAiB,wBAAjB,CAAN;;AAEA,QAAI9D,OAAO,CAACyF,MAAZ,EAAoB;AAClB,YAAM,KAAKD,OAAL,CAAatD,OAAb,CAAN;AACD;;AAED,SAAKnC,GAAL,CAASyE,IAAT,CAAe,wBAAuBU,IAAK,gBAAeU,MAAO,GAAjE;AACD;;AAED,QAAMS,SAAN,CAAgBnE,OAAhB,EAAyBlC,OAAO,GAAG,EAAnC,EAAuC;AACrC,UAAM,KAAK0F,2BAAL,EAAN;AAEA,UAAME,MAAM,GAAG5F,OAAO,CAAC4F,MAAR,KAAmB,MAAM,KAAKD,iBAAL,EAAzB,CAAf;;AACA,UAAMT,IAAI,GAAGpD,cAAKkD,QAAL,CAAc9C,OAAd,CAAb;;AAEA,SAAKnC,GAAL,CAASgF,KAAT,CAAgB,yBAAwBG,IAAK,gBAAeU,MAAO,MAAnE;AAEA,UAAMU,OAAO,GAAG,MAAM,KAAK5F,eAAL,CACnB,kCAAiCkF,MAAO,EADrB,CAAtB;AAGA,UAAMW,cAAc,GAAG,MAAM,KAAK7F,eAAL,CAC1B,kCAAiC4F,OAAQ,IADf,CAA7B;AAIA,SAAKvG,GAAL,CAASgF,KAAT,CAAgB,wBAAuBwB,cAAe,MAAtD;AACA,UAAM,KAAKzC,WAAL,CAAkB,gBAAeyC,cAAe,EAAhD,CAAN;AACA,SAAKxG,GAAL,CAASgF,KAAT,CAAe,yBAAf;AACA,UAAM,wBAAU,SAAV,CAAN;AACA,UAAM,KAAKjB,WAAL,CAAiB,oBAAjB,CAAN;;AAEA,QAAI;AACF,UAAI9D,OAAO,CAACoF,KAAZ,EAAmB;AACjB,cAAM,KAAKH,MAAL,CAAY/C,OAAZ,CAAN;AACD;;AACD,YAAM,KAAKiD,QAAL,CAAcjD,OAAd,CAAN;AACA,YAAM,KAAKmD,MAAL,CAAYnD,OAAZ,CAAN;AACA,YAAM,KAAKwC,KAAL,CAAWxC,OAAX,CAAN;AACD,KAPD,CAOE,OAAOb,KAAP,EAAc;AACd,YAAM,KAAKyC,WAAL,CAAkB,gBAAeyC,cAAe,IAAhD,CAAN;AACA,YAAM,IAAI/F,KAAJ,CAAW,oBAAmB+F,cAAe,GAA7C,CAAN;AACD;;AAED,QAAIvG,OAAO,CAACyF,MAAZ,EAAoB;AAClB,YAAM,KAAKD,OAAL,CAAatD,OAAb,CAAN;AACD;;AAED,SAAKnC,GAAL,CAASyE,IAAT,CAAe,yBAAwBU,IAAK,gBAAeU,MAAO,GAAlE;AACD;;AAED,QAAMY,QAAN,CAAeC,QAAf,EAAyBC,SAAzB,EAAoC1G,OAApC,EAA6C;AAC3C,SAAK2E,OAAL,GAAe,MAAM,KAAKpD,eAAL,EAArB;;AACA,SAAKrB,eAAL,CAAqBuG,QAArB;;AAEA,SAAK,MAAMvE,OAAX,IAAsB,KAAKyC,OAAL,CAAajB,KAAnC,EAA0C;AACxC,YAAMgD,SAAS,CAACC,KAAV,CAAgB,IAAhB,EAAsB,CAACzE,OAAD,EAAUlC,OAAV,CAAtB,CAAN;AACD;AACF;;AAED,QAAM4G,QAAN,CAAe5G,OAAf,EAAwB;AACtB,SAAK2E,OAAL,GAAe,MAAM,KAAKpD,eAAL,EAArB;;AACA,SAAKrB,eAAL,CAAqB,CAAC,WAAD,CAArB;;AAEA,UAAM2G,UAAU,GAAGC,aAAIC,QAAJ,EAAnB;;AACA,UAAMC,YAAY,GAAGF,aAAIC,QAAJ,EAArB;;AAEA,UAAM,wBACJC,YAAY,CAAC9B,IADT,EAEH;;;;;;;;;;;CAFG,CAAN;AAgBA,QAAI+B,MAAM,GAAI;;;KAAd;AAIA,QAAIC,QAAQ,GAAG,IAAf,CA3BsB,CA6BtB;;AACA,SAAK,MAAMhF,OAAX,IAAsB,KAAKyC,OAAL,CAAajB,KAAnC,EAA0C;AACxC,YAAMpB,GAAG,GAAG,KAAKqC,OAAL,CAAalB,IAAb,CAAkBmB,GAAlB,CAAsB1C,OAAtB,CAAZ;;AAEA,UAAI,CAACI,GAAG,CAACE,OAAJ,CAAYqC,OAAjB,EAA0B;AACxB;AACD;;AAED,UAAIsC,UAAU,GAAG,EAAjB;;AAEA,UAAInH,OAAO,CAACoH,YAAZ,EAA0B;AACxB,cAAMC,UAAU,GAAGrE,MAAM,CAACsE,mBAAP,CACjBhF,GAAG,CAACE,OAAJ,CAAYqC,OADK,EAEjB0C,MAFiB,CAETtD,CAAD,IAAOA,CAAC,CAACd,UAAF,CAAa,QAAb,KAA0B,CAACc,CAAC,CAACuD,QAAF,CAAW,QAAX,CAFxB,CAAnB;;AAIA,YAAIH,UAAU,CAAC9D,MAAX,GAAoB,CAAxB,EAA2B;AACzB4D,UAAAA,UAAU,GAAGE,UAAU,CAACzF,GAAX,CAAgBsD,IAAD,KAAW;AACrCA,YAAAA,IADqC;AAErCuC,YAAAA,KAAK,EAAEvC,IAAI,CAAC5B,SAAL,CAAe,SAASC,MAAxB,CAF8B;AAGrCmE,YAAAA,KAAK,EAAE;AAH8B,WAAX,CAAf,CAAb;AAKD;AACF;;AAED,UAAIP,UAAU,CAAC5D,MAAX,KAAsB,CAA1B,EAA6B;AAC3B,YAAI,CAACjB,GAAG,CAACE,OAAJ,CAAYqC,OAAZ,CAAoB8C,KAAzB,EAAgC;AAC9B;AACD;;AAED,cAAMC,SAAS,GACbtF,GAAG,CAACE,OAAJ,CAAYqF,QAAZ,KACEC,KAAK,CAACC,OAAN,CAAczF,GAAG,CAACE,OAAJ,CAAYqF,QAA1B,KACAvF,GAAG,CAACE,OAAJ,CAAYqF,QAAZ,CAAqBG,QAArB,CAA8B,SAA9B,CADD,IAEC1F,GAAG,CAACE,OAAJ,CAAYqF,QAAZ,CAAqBI,cAArB,CAAoC,SAApC,CAHF,CADF;AAMAd,QAAAA,UAAU,GAAG,CACX;AACEjC,UAAAA,IAAI,EAAE,OADR;AAEEuC,UAAAA,KAAK,EAAE3F,cAAKkD,QAAL,CAAc9C,OAAd,CAFT;AAGEwF,UAAAA,KAAK,EAAEE,SAAS,GAAG,SAAH,GAAe;AAHjC,SADW,CAAb;AAOD;;AAEDT,MAAAA,UAAU,CAAC9G,OAAX,CAAoB6H,MAAD,IAAY;AAC7B,YAAIhB,QAAJ,EAAc;AACZD,UAAAA,MAAM,IAAK;;uBAEE/E,OAAQ,WAAUgG,MAAM,CAACT,KAAM,eAC1CS,MAAM,CAACR,KACR,aAAYQ,MAAM,CAAChD,IAAK;;CAJzB;AAOAgC,UAAAA,QAAQ,GAAG,KAAX;AACD,SATD,MASO;AACLD,UAAAA,MAAM,IAAK;;;;yBAII/E,OAAQ,WAAUgG,MAAM,CAACT,KAAM,eAC5CS,MAAM,CAACR,KACR,aAAYQ,MAAM,CAAChD,IAAK;;;CANzB;AAUD;AACF,OAtBD;AAuBD;;AACD+B,IAAAA,MAAM,IAAK;;;CAAX;AAKA,UAAM,wBAAUJ,UAAU,CAAC3B,IAArB,EAA2B+B,MAA3B,CAAN;;AAEA,QAAI,KAAKhH,KAAT,EAAgB;AACd,WAAKF,GAAL,CAASyE,IAAT,CAAcyC,MAAd;AACD;;AAED,UAAM,KAAKnD,WAAL,CACH,UAASkD,YAAY,CAAC9B,IAAK,iBAAgB2B,UAAU,CAAC3B,IAAK,EADxD,EAEJ;AACEiD,MAAAA,KAAK,EAAE;AADT,KAFI,CAAN;AAMD;;AAED,QAAMC,OAAN,GAAgB;AACd,UAAM,KAAK5B,QAAL,CAAc,CAAC,KAAD,CAAd,EAAuB,KAAK9B,KAA5B,EAAmC1E,OAAnC,CAAN;AACD;;AAED,QAAMqI,QAAN,GAAiB;AACf,UAAM,KAAK7B,QAAL,CAAc,CAAC,KAAD,CAAd,EAAuB,KAAKvB,MAA5B,EAAoCjF,OAApC,CAAN;AACD;;AAED,QAAMsI,UAAN,CAAiBtI,OAAjB,EAA0B;AACxB,UAAM,KAAKwG,QAAL,CAAc,CAAC,KAAD,CAAd,EAAuB,KAAKrB,QAA5B,EAAsCnF,OAAtC,CAAN;AACD;;AAED,QAAMuI,QAAN,CAAevI,OAAf,EAAwB;AACtB,UAAM,KAAKwG,QAAL,CAAc,CAAC,KAAD,CAAd,EAAuB,KAAKnB,MAA5B,EAAoCrF,OAApC,CAAN;AACD;;AAED,QAAMwI,UAAN,CAAiBxI,OAAjB,EAA0B;AACxB,UAAM,KAAKwG,QAAL,CACJ,CAAC,UAAD,EAAa,KAAb,EAAoB,KAApB,EAA2B,KAA3B,CADI,EAEJ,KAAKV,QAFD,EAGJ9F,OAHI,CAAN;AAKD;;AAED,QAAMyI,SAAN,GAAkB;AAChB,UAAM,KAAKjC,QAAL,CAAc,CAAC,KAAD,CAAd,EAAuB,KAAKV,QAA5B,EAAsC9F,OAAtC,CAAN;AACD;;AAED,QAAM0I,WAAN,CAAkB1I,OAAlB,EAA2B;AACzB,UAAM,KAAKwG,QAAL,CACJ,CAAC,UAAD,EAAa,KAAb,EAAoB,KAApB,EAA2B,KAA3B,CADI,EAEJ,KAAKH,SAFD,EAGJrG,OAHI,CAAN;AAKD;;AAED,QAAM2I,GAAN,CAAUC,IAAV,EAAgB;AACd,UAAM5I,OAAO,GAAG;AACd6I,MAAAA,OAAO,EAAE,CAAC,MAAD,EAAS,SAAT,EAAoB,OAApB,EAA6B,SAA7B,EAAwC,QAAxC,EAAkD,OAAlD,CADK;AAEdC,MAAAA,MAAM,EAAE,CAAC,QAAD,CAFM;AAGdC,MAAAA,KAAK,EAAE;AACLC,QAAAA,CAAC,EAAE;AADE;AAHO,KAAhB;AAOA,UAAMC,IAAI,GAAG,uBAAUL,IAAV,EAAgB5I,OAAhB,CAAb;AAEA,SAAKC,KAAL,GAAagJ,IAAI,CAAChJ,KAAlB;;AAEA,QAAIgJ,IAAI,CAAClD,OAAT,EAAkB;AAChB,WAAKhG,GAAL,CAASyE,IAAT,CAAe,GAAE0E,oBAAY,EAA7B;AACA,aAAO,CAAP;AACD;;AAED,QAAIvI,OAAO,GAAG,MAAd;;AAEA,QAAIsI,IAAI,CAACE,CAAL,CAAO5F,MAAP,GAAgB,CAApB,EAAuB;AACrB5C,MAAAA,OAAO,GAAGsI,IAAI,CAACE,CAAL,CAAO,CAAP,EAAUC,WAAV,EAAV;;AACAH,MAAAA,IAAI,CAACE,CAAL,CAAOE,KAAP;AACD;;AAED,YAAQ1I,OAAR;AACE,WAAK,OAAL;AACE,YAAIsI,IAAI,CAACK,IAAT,EAAe;AACb,eAAKvJ,GAAL,CAASyE,IAAT,CAAe,UAAS,KAAK1E,QAAS;;;;;;;;;CAAtC;AAUA,iBAAO,CAAP;AACD;;AACD,cAAM,KAAK8G,QAAL,CAAc;AAAEQ,UAAAA,YAAY,EAAE,CAAC,CAAC6B,IAAI,CAACM;AAAvB,SAAd,CAAN;AACA;;AAEF,WAAK,OAAL;AACE,YAAIN,IAAI,CAACK,IAAT,EAAe;AACb,eAAKvJ,GAAL,CAASyE,IAAT,CAAe,UAAS,KAAK1E,QAAS;;;;;CAAtC;AAMA,iBAAO,CAAP;AACD;;AACD,cAAM,KAAKuI,QAAL,EAAN;AACA;;AAEF,WAAK,SAAL;AACE,YAAIY,IAAI,CAACK,IAAT,EAAe;AACb,eAAKvJ,GAAL,CAASyE,IAAT,CAAe,UAAS,KAAK1E,QAAS;;;;;;;;GAAtC;AASA,iBAAO,CAAP;AACD;;AACD,cAAM,KAAKwI,UAAL,CAAgB;AAAElD,UAAAA,KAAK,EAAE,CAAC,CAAC6D,IAAI,CAAC7D;AAAhB,SAAhB,CAAN;AACA;;AAEF,WAAK,OAAL;AACE,YAAI6D,IAAI,CAACK,IAAT,EAAe;AACb,eAAKvJ,GAAL,CAASyE,IAAT,CAAe,UAAS,KAAK1E,QAAS;;;;;;;;;CAAtC;AAUA,iBAAO,CAAP;AACD;;AACD,cAAM,KAAKyI,QAAL,CAAc;AAAEnD,UAAAA,KAAK,EAAE,CAAC,CAAC6D,IAAI,CAAC7D,KAAhB;AAAuBE,UAAAA,OAAO,EAAE,CAAC,CAAC2D,IAAI,CAAC3D;AAAvC,SAAd,CAAN;AACA;;AAEF,WAAK,MAAL;AACE,YAAI2D,IAAI,CAACK,IAAT,EAAe;AACb,eAAKvJ,GAAL,CAASyE,IAAT,CAAe,UAAS,KAAK1E,QAAS;;;;;CAAtC;AAMA,iBAAO,CAAP;AACD;;AACD,cAAM,KAAKsI,OAAL,EAAN;AACA;;AAEF,WAAK,QAAL;AACE,YAAIa,IAAI,CAACK,IAAT,EAAe;AACb,eAAKvJ,GAAL,CAASyE,IAAT,CAAe,UAAS,KAAK1E,QAAS;;;;;;CAAtC;AAOA,iBAAO,CAAP;AACD;;AACD,cAAM,KAAK2I,SAAL,EAAN;AACA;;AAEF,WAAK,SAAL;AACE,YAAIQ,IAAI,CAACK,IAAT,EAAe;AACb,eAAKvJ,GAAL,CAASyE,IAAT,CAAe,UACb,KAAK1E,QACN;;;;;;;;;;;CAFD;AAcA,iBAAO,CAAP;AACD;;AACD,cAAM,KAAK0I,UAAL,CAAgB;AACpBzC,UAAAA,OAAO,EAAEkD,IAAI,CAACE,CAAL,CAAO,CAAP,CADW;AAEpB1D,UAAAA,MAAM,EAAE,CAAC,CAACwD,IAAI,CAACxD,MAFK;AAGpBG,UAAAA,MAAM,EAAEqD,IAAI,CAACrD,MAHO;AAIpBR,UAAAA,KAAK,EAAE,CAAC,CAAC6D,IAAI,CAAC7D;AAJM,SAAhB,CAAN;AAMA;;AAEF,WAAK,UAAL;AACE,YAAI6D,IAAI,CAACK,IAAT,EAAe;AACb,eAAKvJ,GAAL,CAASyE,IAAT,CAAe,UAAS,KAAK1E,QAAS;;;;;;;;;;CAAtC;AAWA,iBAAO,CAAP;AACD;;AACD,cAAM,KAAK4I,WAAL,CAAiB;AACrBjD,UAAAA,MAAM,EAAE,CAAC,CAACwD,IAAI,CAACxD,MADM;AAErBG,UAAAA,MAAM,EAAEqD,IAAI,CAACrD,MAFQ;AAGrBR,UAAAA,KAAK,EAAE,CAAC,CAAC6D,IAAI,CAAC7D;AAHO,SAAjB,CAAN;AAKA;;AAEF,WAAK,MAAL;AACA;AACE,aAAKrF,GAAL,CAASyE,IAAT,CAAe;SACd,KAAK1E,QAAS;;;;;;;;;;;;;;;;;;;;;;;;CADf;AA0BA,eAAO,CAAP;AAvKJ;;AA0KA,WAAO,CAAP;AACD;;AAluBmB","sourcesContent":["import { sync as globSync } from \"glob\"\nimport parseArgs from \"minimist\"\nimport { fullVersion } from \"./version\"\nimport toposort from \"toposort\"\nimport { readFile, writeFile, remove, exists, ensureDir } from \"fs-extra\"\nimport path from \"path\"\nimport process from \"process\"\nimport { exec } from \"child_process\"\nimport tmp from \"tmp\"\nimport { sync as commandExistsSync } from \"command-exists\"\n\nexport class EasyTool {\n  constructor(toolName, log, options) {\n    options = options || {}\n    this.toolName = toolName\n    this.log = log\n    this.debug = options.debug\n  }\n\n  _ensureCommands(cmds) {\n    this.cmds = this.cmds || new Set()\n\n    cmds.forEach((cmd) => {\n      if (!this.cmds.has(cmd) && !commandExistsSync(cmd)) {\n        throw new Error(`Command '${cmd}' does not exist.  Please install it.`)\n      } else {\n        this.cmds.add(cmd)\n      }\n    })\n  }\n\n  _execAndCapture(command, options) {\n    return new Promise((resolve, reject) => {\n      const cp = exec(command, options)\n      let output = \"\"\n\n      cp.stdout.on(\"data\", (data) => {\n        output += data.toString()\n      })\n\n      cp.on(\"error\", (error) => {\n        reject(error)\n      })\n\n      cp.on(\"exit\", function(code) {\n        if (code !== 0) {\n          reject(new Error(\"Non-zero exit code\"))\n        } else {\n          resolve(output)\n        }\n      })\n    })\n  }\n\n  async _getPackageInfo() {\n    if (!(await exists(\"package.json\"))) {\n      throw new Error(\n        \"The current directory does not contain a package.json file\"\n      )\n    }\n\n    const filenames = globSync(\"**/package.json\", {\n      ignore: [\"**/node_modules/**\", \"**/scratch/**\"],\n      realpath: true,\n    })\n    const dirNames = filenames.map((filename) => path.dirname(filename))\n    const pkgMap = new Map(dirNames.map((dirName) => [dirName, {}]))\n    let edges = []\n    let rootPkg = null\n\n    for (let pair of pkgMap) {\n      const [dirName, pkg] = pair\n      const packageFilename = dirName + \"/package.json\"\n      let content = null\n\n      try {\n        content = JSON.parse(\n          await readFile(packageFilename, { encoding: \"utf8\" })\n        )\n      } catch (error) {\n        this.log.error(`Reading ${packageFilename}`)\n        throw error\n      }\n\n      pkg.content = content\n\n      if (dirName === process.cwd()) {\n        rootPkg = pkg\n      } else if (content.dependencies) {\n        const prefix = \"file:\"\n\n        Object.entries(content.dependencies).forEach((arr) => {\n          if (arr[1].startsWith(prefix)) {\n            const otherdirName = path.resolve(\n              path.join(dirName, arr[1].substring(prefix.length))\n            )\n\n            if (pkgMap.has(otherdirName)) {\n              edges.push([dirName, otherdirName])\n            }\n          }\n        })\n      }\n    }\n\n    return {\n      pkgs: pkgMap,\n      order: toposort.array(dirNames, edges).reverse(),\n      rootPkg,\n    }\n  }\n\n  _execAndLog(command, options = {}) {\n    return new Promise((resolve, reject) => {\n      const cp = exec(command, options)\n      const re = new RegExp(/\\n$/)\n\n      cp.stdout.on(\"data\", (data) => {\n        const s = data.toString().replace(re, \"\")\n\n        if (options.ansible) {\n          if (s.startsWith(\"ok: \")) {\n            this.log.ansibleOK(s)\n          } else if (s.startsWith(\"changed: \")) {\n            this.log.ansibleChanged(s)\n          } else if (s.startsWith(\"skipping: \")) {\n            this.log.ansibleSkipping(s)\n          } else if (s.startsWith(\"error: \")) {\n            this.log.ansibleError(s)\n          } else {\n            this.log.info(s)\n          }\n        } else {\n          this.log.info(s)\n        }\n      })\n\n      cp.stderr.on(\"data\", (data) => {\n        const s = data.toString().replace(re, \"\")\n\n        if (s !== \"npm\" && s !== \"notice\" && s !== \"npm notice\") {\n          this.log.info(s)\n        }\n      })\n\n      cp.on(\"error\", (error) => {\n        reject(error)\n      })\n\n      cp.on(\"exit\", function(code) {\n        if (code !== 0) {\n          reject(new Error(\"Exit code non-zero\"))\n        } else {\n          resolve()\n        }\n      })\n    })\n  }\n\n  _execAndCapture(command, options) {\n    return new Promise((resolve, reject) => {\n      const cp = exec(command, options)\n      let output = \"\"\n\n      cp.stdout.on(\"data\", (data) => {\n        output += data.toString()\n      })\n\n      cp.on(\"error\", (error) => {\n        reject(error)\n      })\n\n      cp.on(\"exit\", function(code) {\n        if (code !== 0) {\n          reject(new Error(\"Exit code non-zero\"))\n        } else {\n          resolve(output)\n        }\n      })\n    })\n  }\n\n  async _test(dirName) {\n    const pkg = this.pkgInfo.pkgs.get(dirName)\n\n    if (pkg.content.scripts && pkg.content.scripts.test) {\n      this.log.info2(`Testing '${path.basename(dirName)}'...`)\n      await this._execAndLog(`npm test`, { cwd: dirName })\n    }\n  }\n\n  async _clean(dirName) {\n    const name = path.basename(dirName)\n\n    this.log.info2(`Cleaning '${name}'...`)\n    await remove(path.join(dirName, \"node_modules\"))\n    await remove(path.join(dirName, \"package-lock.json\"))\n    await remove(path.join(dirName, \"dist\"))\n    await remove(path.join(dirName, \"build\"))\n  }\n\n  async _install(dirName, options = {}) {\n    const name = path.basename(dirName)\n\n    if (options.clean) {\n      await this._clean(dirName)\n    }\n\n    this.log.info2(`Installing modules in '${name}'...`)\n    await this._execAndLog(`npm install`, { cwd: dirName })\n  }\n\n  async _build(dirName, options = {}) {\n    const pkg = this.pkgInfo.pkgs.get(dirName)\n    const name = path.basename(dirName)\n\n    if (options.install) {\n      await this._install(dirName)\n    }\n\n    if (pkg.content.scripts && pkg.content.scripts.build) {\n      this.log.info2(`Building '${name}'...`)\n      await this._execAndLog(\"npm run build\", { cwd: dirName })\n    }\n  }\n\n  async _deploy(dirName) {\n    const pkg = this.pkgInfo.pkgs.get(dirName)\n    const name = path.basename(dirName)\n\n    if (pkg.content.scripts && pkg.content.scripts.deploy) {\n      this.log.info2(`Deploying '${name}'...`)\n      await this._execAndLog(\"npm run deploy\", {\n        cwd: dirName,\n        ansible: true,\n      })\n    }\n  }\n\n  async _checkForUncommittedChanges() {\n    this.log.info2(\"Checking for uncommitted changes...\")\n    try {\n      await this._execAndLog(\"git diff-index --quiet HEAD --\")\n    } catch (error) {\n      throw new Error(\n        \"There are uncomitted changes - commit or stash them and try again\"\n      )\n    }\n  }\n\n  async _getCurrentBranch() {\n    let branch = (await this._execAndCapture(\n      \"git rev-parse --abbrev-ref HEAD\"\n    )).trim()\n\n    if (branch === \"HEAD\") {\n      branch = \"master\"\n    }\n\n    return branch\n  }\n\n  async _release(dirName, options = {}) {\n    if (\n      options.version !== \"major\" &&\n      options.version !== \"minor\" &&\n      options.version !== \"patch\" &&\n      options.version !== \"revision\"\n    ) {\n      throw new Error(\n        `Major, minor, patch or revision must be incremented for release`\n      )\n    }\n\n    await this._checkForUncommittedChanges()\n\n    const branch = options.branch || (await this._getCurrentBranch())\n    const name = path.basename(dirName)\n\n    this.log.info2(`Starting release of '${name}' on branch '${branch}'...`)\n    this.log.info2(`Checking out '${branch}'...`)\n    await this._execAndLog(`git checkout ${branch}`)\n    this.log.info2(\"Pulling latest...\")\n    await this._execAndLog(\"git pull\")\n    this.log.info2(\"Updating version...\")\n    await ensureDir(\"scratch\")\n\n    const incrFlag =\n      options.version === \"patch\"\n        ? \"-i patch\"\n        : options.version === \"minor\"\n        ? \"-i minor\"\n        : options.version === \"major\"\n        ? \"-i major\"\n        : \"\"\n\n    await this._execAndLog(`npx stampver ${incrFlag} -u -s`)\n\n    let tagName = await readFile(\"scratch/version.tag.txt\")\n    let tagDescription = await readFile(\"scratch/version.desc.txt\")\n\n    if (branch !== \"master\") {\n      const suffix = \"-\" + branch\n\n      tagName += suffix\n      tagDescription += suffix\n    }\n\n    let isNewTag = true\n    try {\n      await this._execAndCapture(`git rev-parse ${tagName}`)\n      isNewTag = false\n    } catch (error) {\n      this.log.info(`Confirmed that '${tagName}' is a new tag`)\n    }\n\n    if (!isNewTag) {\n      await this._execAndLog(`git checkout ${branch} .`)\n      throw new Error(\n        \"Cannot re-release an existing version; do a patch release\"\n      )\n    }\n\n    try {\n      if (options.clean) {\n        await this._clean(dirName)\n      }\n      await this._install(dirName)\n      await this._build(dirName)\n      await this._test(dirName)\n    } catch (error) {\n      // Roll back version changes if anything went wrong\n      await this._execAndLog(`git checkout ${branch} .`)\n      throw new Error(`Failed to build ${name} on branch '${branch}'`)\n    }\n\n    this.log.info2(\"Staging version changes...\")\n    await this._execAndLog(\"git add :/\")\n    this.log.info(\"Committing version changes...\")\n    await this._execAndLog(`git commit -m '${tagDescription}'`)\n\n    this.log.info2(\"Tagging...\")\n    await this._execAndLog(`git tag -a '${tagName}' -m '${tagDescription}'`)\n    this.log.info2(\"Pushing to Git...\")\n    await this._execAndLog(\"git push --follow-tags\")\n\n    if (options.deploy) {\n      await this._deploy(dirName)\n    }\n\n    this.log.info(`Finished release of '${name}' on branch '${branch}'`)\n  }\n\n  async _rollback(dirName, options = {}) {\n    await this._checkForUncommittedChanges()\n\n    const branch = options.branch || (await this._getCurrentBranch())\n    const name = path.basename(dirName)\n\n    this.log.info2(`Starting rollback of '${name}' on branch '${branch}'...`)\n\n    const lastTag = await this._execAndCapture(\n      `git describe --tags --abbrev=0 ${branch}`\n    )\n    const penultimateTag = await this._execAndCapture(\n      `git describe --tags --abbrev=0 ${lastTag}~1`\n    )\n\n    this.log.info2(`Rolling back to tag '${penultimateTag}'...`)\n    await this._execAndLog(`git checkout ${penultimateTag}`)\n    this.log.info2(\"Rolling back version...\")\n    await ensureDir(\"scratch\")\n    await this._execAndLog(\"npx stampver -u -s\")\n\n    try {\n      if (options.clean) {\n        await this._clean(dirName)\n      }\n      await this._install(dirName)\n      await this._build(dirName)\n      await this._test(dirName)\n    } catch (error) {\n      await this._execAndLog(`git checkout ${penultimateTag} .`)\n      throw new Error(`Failed to build '${penultimateTag}'`)\n    }\n\n    if (options.deploy) {\n      await this._deploy(dirName)\n    }\n\n    this.log.info(`Finished rollback of '${name}' on branch '${branch}'`)\n  }\n\n  async _recurse(commands, operation, options) {\n    this.pkgInfo = await this._getPackageInfo()\n    this._ensureCommands(commands)\n\n    for (const dirName of this.pkgInfo.order) {\n      await operation.apply(this, [dirName, options])\n    }\n  }\n\n  async startAll(options) {\n    this.pkgInfo = await this._getPackageInfo()\n    this._ensureCommands([\"osascript\"])\n\n    const tmpObjMain = tmp.fileSync()\n    const tmpObjHelper = tmp.fileSync()\n\n    await writeFile(\n      tmpObjHelper.name,\n      `# function for setting iTerm2 titles\nfunction title {\n  printf \"\\\\x1b]0;%s\\\\x7\" \"$1\"\n}\n\n# function for setting iTerm2 tab colors\nfunction tab-color {\n  printf \"\\\\x1b]6;1;bg;red;brightness;%s\\\\x7\" \"$1\"\n  printf \"\\\\x1b]6;1;bg;green;brightness;%s\\\\x7\" \"$2\"\n  printf \"\\\\x1b]6;1;bg;blue;brightness;%s\\\\x7\" \"$3\"\n}\n`\n    )\n\n    let script = `\ntell application \"iTerm\"\n  tell (create window with default profile)\n    `\n    let firstTab = true\n\n    // Loop through package.json dirs\n    for (const dirName of this.pkgInfo.order) {\n      const pkg = this.pkgInfo.pkgs.get(dirName)\n\n      if (!pkg.content.scripts) {\n        continue\n      }\n\n      let tabDetails = []\n\n      if (options.preferActors) {\n        const actorNames = Object.getOwnPropertyNames(\n          pkg.content.scripts\n        ).filter((s) => s.startsWith(\"actor:\") && !s.endsWith(\":debug\"))\n\n        if (actorNames.length > 0) {\n          tabDetails = actorNames.map((name) => ({\n            name,\n            title: name.substring(\"actor:\".length),\n            color: \"255 198 0\",\n          }))\n        }\n      }\n\n      if (tabDetails.length === 0) {\n        if (!pkg.content.scripts.start) {\n          continue\n        }\n\n        const isLibrary =\n          pkg.content.keywords &&\n          ((Array.isArray(pkg.content.keywords) &&\n            pkg.content.keywords.includes(\"library\")) ||\n            pkg.content.keywords.hasOwnProperty(\"library\"))\n\n        tabDetails = [\n          {\n            name: \"start\",\n            title: path.basename(dirName),\n            color: isLibrary ? \"0 255 0\" : \"0 198 255\",\n          },\n        ]\n      }\n\n      tabDetails.forEach((detail) => {\n        if (firstTab) {\n          script += `\n    tell current session of current tab\n      write text \"cd ${dirName}; title ${detail.title}; tab-color ${\n            detail.color\n          }; npm run ${detail.name}\"\n    end tell\n`\n          firstTab = false\n        } else {\n          script += `\n    set newTab to (create tab with default profile)\n    tell newTab\n      tell current session of newTab\n        write text \"cd ${dirName}; title ${detail.title}; tab-color ${\n            detail.color\n          }; npm run ${detail.name}\"\n      end tell\n    end tell\n`\n        }\n      })\n    }\n    script += `\n  end tell\nend tell\n`\n\n    await writeFile(tmpObjMain.name, script)\n\n    if (this.debug) {\n      this.log.info(script)\n    }\n\n    await this._execAndLog(\n      `source ${tmpObjHelper.name}; osascript < ${tmpObjMain.name}`,\n      {\n        shell: \"/bin/bash\",\n      }\n    )\n  }\n\n  async testAll() {\n    await this._recurse([\"npm\"], this._test, options)\n  }\n\n  async cleanAll() {\n    await this._recurse([\"npm\"], this._clean, options)\n  }\n\n  async installAll(options) {\n    await this._recurse([\"npm\"], this._install, options)\n  }\n\n  async buildAll(options) {\n    await this._recurse([\"npm\"], this._build, options)\n  }\n\n  async releaseAll(options) {\n    await this._recurse(\n      [\"stampver\", \"git\", \"npx\", \"npm\"],\n      this._release,\n      options\n    )\n  }\n\n  async deployAll() {\n    await this._recurse([\"npm\"], this._release, options)\n  }\n\n  async rollbackAll(options) {\n    await this._recurse(\n      [\"stampver\", \"git\", \"npx\", \"npm\"],\n      this._rollback,\n      options\n    )\n  }\n\n  async run(argv) {\n    const options = {\n      boolean: [\"help\", \"version\", \"clean\", \"install\", \"actors\", \"debug\"],\n      string: [\"branch\"],\n      alias: {\n        a: \"actors\",\n      },\n    }\n    const args = parseArgs(argv, options)\n\n    this.debug = args.debug\n\n    if (args.version) {\n      this.log.info(`${fullVersion}`)\n      return 0\n    }\n\n    let command = \"help\"\n\n    if (args._.length > 0) {\n      command = args._[0].toLowerCase()\n      args._.shift()\n    }\n\n    switch (command) {\n      case \"start\":\n        if (args.help) {\n          this.log.info(`Usage: ${this.toolName} start [options]\n\nDescription:\n\nRecursively runs 'npm start' in all directories containing 'package.json' except 'node_modules/**'.\n\nOptions:\n  --actors, -a    If one or more 'actor:*' scripts are found in the package.json,\n                  run those instead of the 'start' script, if it exists.\n`)\n          return 0\n        }\n        await this.startAll({ preferActors: !!args.actors })\n        break\n\n      case \"clean\":\n        if (args.help) {\n          this.log.info(`Usage: ${this.toolName} clean\n\nDescription:\n\nRecursively deletes all 'dist' and 'node_modules' directories, and 'package-lock.json' files.\n`)\n          return 0\n        }\n        await this.cleanAll()\n        break\n\n      case \"install\":\n        if (args.help) {\n          this.log.info(`Usage: ${this.toolName} install\n\nDescription:\n\nRecursively runs 'npm install' in all directories containing 'package.json' except 'node_modules/**'.\n\nOptions:\n  --clean         Runs a clean before installing\n  `)\n          return 0\n        }\n        await this.installAll({ clean: !!args.clean })\n        break\n\n      case \"build\":\n        if (args.help) {\n          this.log.info(`Usage: ${this.toolName} build\n\nDescription:\n\nRecursively runs 'npm run build' in all directories containing 'package.json' except 'node_modules/**'.\n\nOptions:\n  --install       Recursively runs 'npm install' before building\n  --clean         If '--install' is specified, does a '--clean' first\n`)\n          return 0\n        }\n        await this.buildAll({ clean: !!args.clean, install: !!args.install })\n        break\n\n      case \"test\":\n        if (args.help) {\n          this.log.info(`Usage: ${this.toolName} test\n\nDescription:\n\nRecursively runs 'npm test' in all directories containing 'package.json' except 'node_modules/**'.\n`)\n          return 0\n        }\n        await this.testAll()\n        break\n\n      case \"deploy\":\n        if (args.help) {\n          this.log.info(`Usage: ${this.toolName} deploy\n\nDescription:\n\nRecursively runs 'npm run deploy' in all directories containing 'package.json' except 'node_modules/**'.\nWill colorize Ansible output if detected.\n`)\n          return 0\n        }\n        await this.deployAll()\n        break\n\n      case \"release\":\n        if (args.help) {\n          this.log.info(`Usage: ${\n            this.toolName\n          } release [major|minor|patch] [options]\n\nDescription:\n\nUpdate version information, 'install', 'build' and 'test',\ntag local Git repo and push changes then optionally run a 'deploy'.\n\nOptions:\n  --deploy      Run a deployment after a success release\n  --branch      Will operate on a specific branch. Defaults to 'master'.\n  --clean       Clean before installing\n`)\n          return 0\n        }\n        await this.releaseAll({\n          version: args._[0],\n          deploy: !!args.deploy,\n          branch: args.branch,\n          clean: !!args.clean,\n        })\n        break\n\n      case \"rollback\":\n        if (args.help) {\n          this.log.info(`Usage: ${this.toolName} rollback [options]\n\nDescription:\n\nRollback to last release, 'install', 'build' and 'test'. Optionally run a 'deploy'.\n\nOptions:\n  --deploy      Run a deployment after a success release\n  --branch      Will operate on a specific branch. Defaults to 'master'.\n  --clean       Clean before installing\n`)\n          return 0\n        }\n        await this.rollbackAll({\n          deploy: !!args.deploy,\n          branch: args.branch,\n          clean: !!args.clean,\n        })\n        break\n\n      case \"help\":\n      default:\n        this.log.info(`\nUsage: ${this.toolName} <cmd> [options]\n\nDescription:\n\nEasily install, build, test, release or deploy npm based packages.\n\nThe current directory should contain a package.json, which can be an empty file.\nWill recursively operate on all package.json files in a source tree.\n\nCommands:\n  start       Run 'npm start' in new terminal tabs.\n              Requires iTerm2 (https://www.iterm2.com/)\n  build       Run 'npm run build'\n  deploy      Run 'npm run deploy'\n  test        Run 'npm test'\n  install     Run 'npm install'\n  clean       Remove 'node_modules', distribution and build files\n  release     Update version, build, test, tag and push to origin\n  rollback    Rollback to last tagged release, build and test\n\nGlobal Options:\n  --help      Shows this help\n  --version   Shows the tool version\n  --debug     Enable debugging output\n`)\n        return 0\n    }\n\n    return 0\n  }\n}\n"],"file":"EasyTool.js"}