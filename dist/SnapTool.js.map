{"version":3,"sources":["../src/SnapTool.js"],"names":["SnapTool","constructor","log","ensureCommands","cmds","forEach","cmd","Error","getProject","filenames","ignore","realpath","dirnames","map","filename","dirname","pkgMap","Map","edges","rootPkg","pair","pkg","content","JSON","parse","encoding","cwd","dependencies","prefix","Object","entries","arr","startsWith","otherDirname","resolve","join","substring","length","has","push","pkgs","order","array","reverse","startAll","project","tempFile","file","rootDir","script","index","get","size","scripts","start","name","basename","color","keywords","includes","buildAll","build","args","clean","info","testAll","release","error","incrFlag","patch","minor","major","tagName","tagDescription","private","run","argv","options","boolean","command","_","help","version","toLowerCase"],"mappings":";;;;;;;AAAA;;AACA;;;;AACA;;AACA;;;;AACA;;;;AACA;;AACA;;;;AACA;;;;AACA;;AACA;;;;AACA;;;;AAEO,MAAMA,QAAN,CAAe;AACpBC,cAAYC,GAAZ,EAAiB;AACf,SAAKA,GAAL,GAAWA,GAAX;AACD;;AAED,SAAOC,cAAP,CAAsBC,IAAtB,EAA4B;AAC1BA,SAAKC,OAAL,CAAaC,OAAO;AAClB,UAAI,CAAC,yBAAkBA,GAAlB,CAAL,EAA6B;AAC3B,cAAM,IAAIC,KAAJ,CAAW,YAAWD,GAAI,uCAA1B,CAAN;AACD;AACF,KAJD;AAKD;;AAEDE,eAAa;AACX,QAAI,CAAC,yBAAW,cAAX,CAAL,EAAiC;AAC/B,YAAM,IAAID,KAAJ,CAAU,4DAAV,CAAN;AACD;;AAED,UAAME,YAAY,gBAAS,iBAAT,EAChB,EAAEC,QAAQ,CAAC,oBAAD,EAAuB,eAAvB,CAAV,EAAmDC,UAAU,IAA7D,EADgB,CAAlB;AAEA,UAAMC,WAAWH,UAAUI,GAAV,CAAcC,YAAa,eAAKC,OAAL,CAAaD,QAAb,CAA3B,CAAjB;AACA,UAAME,SAAS,IAAIC,GAAJ,CAAQL,SAASC,GAAT,CAAaE,WAAY,CAACA,OAAD,EAAU,EAAV,CAAzB,CAAR,CAAf;AACA,QAAIG,QAAQ,EAAZ;AACA,QAAIC,UAAU,IAAd;;AAEA,SAAK,IAAIC,IAAT,IAAiBJ,MAAjB,EAAyB;AACvB,YAAM,CAACD,OAAD,EAAUM,GAAV,IAAiBD,IAAvB;AACA,YAAME,UAAUC,KAAKC,KAAL,CAAW,2BAAaT,UAAU,eAAvB,EAAwC,EAAEU,UAAU,MAAZ,EAAxC,CAAX,CAAhB;;AAEAJ,UAAIC,OAAJ,GAAcA,OAAd;;AAEA,UAAIP,YAAY,kBAAQW,GAAR,EAAhB,EAA+B;AAC7BP,kBAAUE,GAAV;AACD,OAFD,MAEO,IAAIC,QAAQK,YAAZ,EAA0B;AAC/B,cAAMC,SAAS,OAAf;;AAEAC,eAAOC,OAAP,CAAeR,QAAQK,YAAvB,EAAqCtB,OAArC,CAA6C0B,OAAO;AAClD,cAAIA,IAAI,CAAJ,EAAOC,UAAP,CAAkBJ,MAAlB,CAAJ,EAA+B;AAC7B,kBAAMK,eAAe,eAAKC,OAAL,CAAa,eAAKC,IAAL,CAAUpB,OAAV,EAAmBgB,IAAI,CAAJ,EAAOK,SAAP,CAAiBR,OAAOS,MAAxB,CAAnB,CAAb,CAArB;;AAEA,gBAAIrB,OAAOsB,GAAP,CAAWL,YAAX,CAAJ,EAA8B;AAC5Bf,oBAAMqB,IAAN,CAAW,CAACxB,OAAD,EAAUkB,YAAV,CAAX;AACD;AACF;AACF,SARD;AASD;AACF;;AAED,WAAO;AACLO,YAAMxB,MADD;AAELyB,aAAO,mBAASC,KAAT,CAAe9B,QAAf,EAAyBM,KAAzB,EAAgCyB,OAAhC,EAFF;AAGLxB;AAHK,KAAP;AAKD;;AAEDyB,WAASC,OAAT,EAAkB;AAChB7C,aAASG,cAAT,CAAwB,CAAC,WAAD,CAAxB;;AAEA,UAAM2C,WAAW,gBAAMC,IAAN,EAAjB;AACA,UAAMC,UAAU,kBAAQtB,GAAR,EAAhB;;AAEA,QAAIuB,SAAU;;;KAAd;AAIAJ,YAAQJ,KAAR,CAAcpC,OAAd,CAAsB,CAACU,OAAD,EAAUmC,KAAV,KAAoB;AACxC,YAAM7B,MAAMwB,QAAQL,IAAR,CAAaW,GAAb,CAAiBpC,OAAjB,CAAZ;;AAEA;AACA,UAAIM,QAAQwB,QAAQ1B,OAAhB,IAA2B0B,QAAQL,IAAR,CAAaY,IAAb,GAAoB,CAAnD,EAAsD;AACpD;AACD;;AAED,UAAI,CAAC/B,IAAIC,OAAJ,CAAY+B,OAAb,IAAwB,CAAChC,IAAIC,OAAJ,CAAY+B,OAAZ,CAAoBC,KAAjD,EAAwD;AACtD;AACD;;AAED,YAAMC,OAAO,eAAKC,QAAL,CAAczC,OAAd,CAAb;AACA,UAAI0C,KAAJ;AACA,UAAIpC,IAAIC,OAAJ,CAAYoC,QAAZ,IAAwBrC,IAAIC,OAAJ,CAAYoC,QAAZ,CAAqBC,QAArB,CAA8B,SAA9B,CAA5B,EAAsE;AACpEF,gBAAQ,SAAR;AACD,OAFD,MAEO;AACLA,gBAAQ,WAAR;AACD;AACD,UAAIP,SAAS,CAAb,EAAgB;AACdD,kBAAW;;2BAEQlC,OAAQ,WAAUwC,IAAK,eAAcE,KAAM;;SAF9D;AAKD,OAND,MAMO;AACLR,kBAAW;;;;6BAIUlC,OAAQ,WAAUwC,IAAK,eAAcE,KAAM;;;SAJhE;AAQD;AACF,KAnCD;AAoCAR,cAAW;;;KAAX;;AAKA,gCAAcH,QAAd,EAAwBG,MAAxB;AACA,iCAAU,eAAcH,QAAS,EAAjC;AACD;;AAEDc,WAASf,OAAT,EAAkB;AAChB7C,aAASG,cAAT,CAAwB,CAAC,KAAD,CAAxB;AACA0C,YAAQJ,KAAR,CAAcpC,OAAd,CAAsB,CAACU,OAAD,EAAUmC,KAAV,KAAoB;AACxC,YAAM7B,MAAMwB,QAAQL,IAAR,CAAaW,GAAb,CAAiBpC,OAAjB,CAAZ;AACA,YAAMwC,OAAO,eAAKC,QAAL,CAAczC,OAAd,CAAb;;AAEA,UAAIM,IAAIC,OAAJ,CAAY+B,OAAZ,IAAuBhC,IAAIC,OAAJ,CAAY+B,OAAZ,CAAoBQ,KAA/C,EAAsD;AACpD,YAAI,KAAKC,IAAL,CAAUC,KAAd,EAAqB;AACjB,eAAK7D,GAAL,CAAS8D,IAAT,CAAe,aAAYT,IAAK,MAAhC;AACA,mCAAW,cAAX;AACA,mCAAW,mBAAX;AACA,mCAAW,MAAX;AACA,eAAKrD,GAAL,CAAS8D,IAAT,CAAc,wBAAd;AACA,uCAAS,aAAT;AACH;;AAED;AACA,YAAI3C,QAAQwB,QAAQ1B,OAAhB,IAA2B0B,QAAQL,IAAR,CAAaY,IAAb,GAAoB,CAAnD,EAAsD;AACpD;AACD;;AAED,aAAKlD,GAAL,CAAS8D,IAAT,CAAe,aAAYT,IAAK,MAAhC;AACA,qCAAS,eAAT,EAA0B,EAAE7B,KAAKX,OAAP,EAA1B;AACD;AACF,KAtBD;AAuBD;;AAEDkD,UAAQpB,OAAR,EAAiB;AACf7C,aAASG,cAAT,CAAwB,CAAC,KAAD,CAAxB;AACA0C,YAAQJ,KAAR,CAAcpC,OAAd,CAAsB,CAACU,OAAD,EAAUmC,KAAV,KAAoB;AACxC,YAAM7B,MAAMwB,QAAQL,IAAR,CAAaW,GAAb,CAAiBpC,OAAjB,CAAZ;;AAEA;AACA,UAAIM,QAAQwB,QAAQ1B,OAAhB,IAA2B0B,QAAQL,IAAR,CAAaY,IAAb,GAAoB,CAAnD,EAAsD;AACpD;AACD;;AAED,UAAI/B,IAAIC,OAAJ,IAAeD,IAAIC,OAAJ,CAAY+B,OAAZ,CAAoBQ,KAAvC,EAA8C;AAC5C,aAAK3D,GAAL,CAAS8D,IAAT,CAAe,YAAW,eAAKR,QAAL,CAAczC,OAAd,CAAuB,MAAjD;AACA,qCAAU,cAAV,EAAyB,EAAEW,KAAKX,OAAP,EAAzB;AACD;AACF,KAZD;AAaD;;AAEDmD,UAAQrB,OAAR,EAAiB;AACf7C,aAASG,cAAT,CAAwB,CAAC,UAAD,EAAa,KAAb,EAAoB,KAApB,EAA2B,KAA3B,CAAxB;AACA,SAAKD,GAAL,CAAS8D,IAAT,CAAc,qCAAd;AACA,QAAI;AACF,mCAAS,gCAAT;AACD,KAFD,CAEE,OAAOG,KAAP,EAAc;AACd,YAAM,IAAI5D,KAAJ,CAAU,mEAAV,CAAN;AACD;;AAED,SAAKL,GAAL,CAAS8D,IAAT,CAAc,YAAd;AACA,iCAAS,UAAT;AACA,SAAK9D,GAAL,CAAS8D,IAAT,CAAc,aAAd;AACA,SAAKJ,QAAL,CAAcf,OAAd;AACA,SAAK3C,GAAL,CAAS8D,IAAT,CAAc,YAAd;AACA,SAAKC,OAAL,CAAapB,OAAb;AACA,SAAK3C,GAAL,CAAS8D,IAAT,CAAc,qBAAd;AACA,gCAAc,SAAd;;AAEA,UAAMI,WAAW,KAAKN,IAAL,CAAUO,KAAV,GAAkB,UAAlB,GAA+B,KAAKP,IAAL,CAAUQ,KAAV,GAAkB,UAAlB,GAA+B,KAAKR,IAAL,CAAUS,KAAV,GAAkB,UAAlB,GAA+B,EAA9G;;AAEA,iCAAU,gBAAeH,QAAS,KAAlC;AACA,UAAMI,UAAU,2BAAa,yBAAb,CAAhB;AACA,UAAMC,iBAAiB,2BAAa,0BAAb,CAAvB;;AAEA,SAAKvE,GAAL,CAAS8D,IAAT,CAAc,+BAAd;AACA,iCAAU,YAAV;;AAEA,QAAI,KAAKF,IAAL,CAAUO,KAAV,IAAmB,KAAKP,IAAL,CAAUQ,KAA7B,IAAsC,KAAKR,IAAL,CAAUS,KAApD,EAA2D;AACzD,WAAKrE,GAAL,CAAS8D,IAAT,CAAc,YAAd;AACA,mCAAU,cAAaQ,OAAQ,QAAOC,cAAe,GAArD;AACD;;AAED,iCAAU,kBAAiBA,cAAe,GAA1C;;AAEA,SAAKvE,GAAL,CAAS8D,IAAT,CAAc,YAAd;AACA,iCAAS,wBAAT;;AAEA,QAAInB,QAAQL,IAAR,CAAaY,IAAb,KAAsB,CAAtB,IAA2B,CAACP,QAAQ1B,OAAR,CAAgBG,OAAhB,CAAwBoD,OAAxD,EAAiE;AAC/D,UAAI,CAAC,KAAKZ,IAAL,CAAUO,KAAX,IAAoB,CAAC,KAAKP,IAAL,CAAUQ,KAA/B,IAAwC,CAAC,KAAKR,IAAL,CAAUS,KAAvD,EAA8D;AAC5D,aAAKrE,GAAL,CAASiE,KAAT,CAAgB,wEAAhB;AACA;AACD;AACD,WAAKjE,GAAL,CAAS8D,IAAT,CAAc,eAAd;AACA,mCAAS,aAAT;AACD;AACF;;AAED,QAAMW,GAAN,CAAUC,IAAV,EAAgB;AACd,UAAMC,UAAU;AACdC,eAAS,CAAE,MAAF,EAAU,SAAV,EAAqB,OAArB,EAA8B,OAA9B,EAAuC,OAAvC,EAAgD,OAAhD;AADK,KAAhB;AAGA,SAAKhB,IAAL,GAAY,wBAAUc,IAAV,EAAgBC,OAAhB,CAAZ;;AAEA,UAAME,UAAU,KAAKjB,IAAL,CAAUkB,CAAV,CAAY,CAAZ,CAAhB;;AAEA,QAAI,KAAKlB,IAAL,CAAUmB,IAAV,IAAkB,CAACF,OAAvB,EAAgC;AAC9B,WAAK7E,GAAL,CAAS8D,IAAT,CAAe;;;;;;;;;;;;CAAf;AAaA,aAAO,CAAP;AACD;;AAED,QAAI,KAAKF,IAAL,CAAUoB,OAAd,EAAuB;AACrB,WAAKhF,GAAL,CAAS8D,IAAT,CAAe,gBAAf;AACA,aAAO,CAAP;AACD;;AAED,UAAMnB,UAAU,KAAKrC,UAAL,EAAhB;;AAEA,YAAQuE,QAAQI,WAAR,EAAR;AACE,WAAK,OAAL;AACE,aAAKvC,QAAL,CAAcC,OAAd;AACA;AACF,WAAK,OAAL;AACE,aAAKe,QAAL,CAAcf,OAAd;AACA;AACF,WAAK,MAAL;AACE,aAAKoB,OAAL,CAAapB,OAAb;AACA;AACF,WAAK,SAAL;AACE,aAAKqB,OAAL,CAAarB,OAAb;AACA;AACF;AACE,aAAK3C,GAAL,CAASiE,KAAT,CAAe,sCAAf;AACA,eAAO,CAAC,CAAR;AAfJ;;AAkBA,WAAO,CAAP;AACD;AA5PmB;QAATnE,Q,GAAAA,Q","file":"SnapTool.js","sourcesContent":["import { sync as globSync } from 'glob'\nimport parseArgs from 'minimist'\nimport { fullVersion } from './version'\nimport util from 'util'\nimport toposort from 'toposort'\nimport { readFileSync, writeFileSync, removeSync, existsSync, ensureDirSync } from 'fs-extra'\nimport path from 'path'\nimport process from 'process'\nimport { execSync } from 'child_process'\nimport tempy from 'tempy'\nimport { sync as commandExistsSync } from 'command-exists'\n\nexport class SnapTool {\n  constructor(log) {\n    this.log = log\n  }\n\n  static ensureCommands(cmds) {\n    cmds.forEach(cmd => {\n      if (!commandExistsSync(cmd)) {\n        throw new Error(`Command '${cmd}' does not exist.  Please install it.`)\n      }\n    })\n  }\n\n  getProject() {\n    if (!existsSync('package.json')) {\n      throw new Error('The current directory does not contain a package.json file')\n    }\n\n    const filenames = globSync('**/package.json',\n      { ignore: ['**/node_modules/**', '**/scratch/**'], realpath: true })\n    const dirnames = filenames.map(filename => (path.dirname(filename)))\n    const pkgMap = new Map(dirnames.map(dirname => ([dirname, {}])))\n    let edges = []\n    let rootPkg = null\n\n    for (let pair of pkgMap) {\n      const [dirname, pkg] = pair\n      const content = JSON.parse(readFileSync(dirname + '/package.json', { encoding: 'utf8' }))\n\n      pkg.content = content\n\n      if (dirname === process.cwd()) {\n        rootPkg = pkg\n      } else if (content.dependencies) {\n        const prefix = 'file:'\n\n        Object.entries(content.dependencies).forEach(arr => {\n          if (arr[1].startsWith(prefix)) {\n            const otherDirname = path.resolve(path.join(dirname, arr[1].substring(prefix.length)))\n\n            if (pkgMap.has(otherDirname)) {\n              edges.push([dirname, otherDirname])\n            }\n          }\n        })\n      }\n    }\n\n    return {\n      pkgs: pkgMap,\n      order: toposort.array(dirnames, edges).reverse(),\n      rootPkg\n    }\n  }\n\n  startAll(project) {\n    SnapTool.ensureCommands(['osascript'])\n\n    const tempFile = tempy.file()\n    const rootDir = process.cwd()\n\n    let script = `\n    tell application \"iTerm\"\n      tell (create window with default profile)\n    `\n    project.order.forEach((dirname, index) => {\n      const pkg = project.pkgs.get(dirname)\n\n      // Ignore the root project if it's not the only entry\n      if (pkg === project.rootPkg && project.pkgs.size > 1) {\n        return\n      }\n\n      if (!pkg.content.scripts || !pkg.content.scripts.start) {\n        return\n      }\n\n      const name = path.basename(dirname)\n      let color\n      if (pkg.content.keywords && pkg.content.keywords.includes('library')) {\n        color = '0 255 0'\n      } else {\n        color = '0 198 255'\n      }\n      if (index == 0) {\n        script += `\n        tell current session of current tab\n          write text \"cd ${dirname}; title ${name}; tab-color ${color}; npm start\"\n        end tell\n        `\n      } else {\n        script += `\n        set newTab to (create tab with default profile)\n        tell newTab\n          tell current session of newTab\n            write text \"cd ${dirname}; title ${name}; tab-color ${color}; npm start\"\n          end tell\n        end tell\n        `\n      }\n    })\n    script += `\n      end tell\n    end tell\n    `\n\n    writeFileSync(tempFile, script)\n    execSync(`osascript < ${tempFile}`)\n  }\n\n  buildAll(project) {\n    SnapTool.ensureCommands(['npm'])\n    project.order.forEach((dirname, index) => {\n      const pkg = project.pkgs.get(dirname)\n      const name = path.basename(dirname)\n\n      if (pkg.content.scripts && pkg.content.scripts.build) {\n        if (this.args.clean) {\n            this.log.info(`Cleaning '${name}'...`)\n            removeSync('node_modules')\n            removeSync('package-lock.json')\n            removeSync('dist')\n            this.log.info('Installing Packages...')\n            execSync('npm install')\n        }\n\n        // Skip build for root project if there are multiple\n        if (pkg === project.rootPkg && project.pkgs.size > 1) {\n          return\n        }\n\n        this.log.info(`Building '${name}'...`)\n        execSync('npm run build', { cwd: dirname})\n      }\n    })\n  }\n\n  testAll(project) {\n    SnapTool.ensureCommands(['npm'])\n    project.order.forEach((dirname, index) => {\n      const pkg = project.pkgs.get(dirname)\n\n      // Skip test for root project if there are multiple\n      if (pkg === project.rootPkg && project.pkgs.size > 1) {\n        return\n      }\n\n      if (pkg.content && pkg.content.scripts.build) {\n        this.log.info(`Testing '${path.basename(dirname)}'...`)\n        execSync(`npm run test`, { cwd: dirname})\n      }\n    })\n  }\n\n  release(project) {\n    SnapTool.ensureCommands(['stampver', 'git', 'npx', 'npm'])\n    this.log.info('Checking for Uncommitted Changes...')\n    try {\n      execSync('git diff-index --quiet HEAD --')\n    } catch (error) {\n      throw new Error('There are uncomitted changes - commit or stash them and try again')\n    }\n\n    this.log.info('Pulling...')\n    execSync('git pull')\n    this.log.info('Building...')\n    this.buildAll(project)\n    this.log.info('Testing...')\n    this.testAll(project)\n    this.log.info('Updating Version...')\n    ensureDirSync('scratch')\n\n    const incrFlag = this.args.patch ? '-i patch' : this.args.minor ? '-i minor' : this.args.major ? '-i major' : ''\n\n    execSync(`npx stampver ${incrFlag} -u`)\n    const tagName = readFileSync('scratch/version.tag.txt')\n    const tagDescription = readFileSync('scratch/version.desc.txt')\n\n    this.log.info('Committing Version Changes...')\n    execSync(`git add :/`)\n\n    if (this.args.patch || this.args.minor || this.args.major) {\n      this.log.info('Tagging...')\n      execSync(`git tag -a ${tagName} -m '${tagDescription}'`)\n    }\n\n    execSync(`git commit -m '${tagDescription}'`)\n\n    this.log.info('Pushing...')\n    execSync('git push --follow-tags')\n\n    if (project.pkgs.size === 1 && !project.rootPkg.content.private) {\n      if (!this.args.patch && !this.args.minor && !this.args.major) {\n        this.log.error(`Not pushing to NPM as major, minor or patch number must be incremented`)\n        return\n      }\n      this.log.info('Publishing...')\n      execSync('npm publish')\n    }\n  }\n\n  async run(argv) {\n    const options = {\n      boolean: [ 'help', 'version', 'patch', 'minor', 'major', 'clean' ],\n    }\n    this.args = parseArgs(argv, options)\n\n    const command = this.args._[0]\n\n    if (this.args.help || !command) {\n      this.log.info(`\nusage: snap <cmd> [options]\n\ncommands:\n  start            Run 'npm start' for all projects\n  build            Run 'npm build' for all projects\n  test             Run 'npm test' for all projects\n  release          Increment version, run build' and 'test', tag and release non-private to 'npm'\n\noptions:\n  --patch | --minor | --major   Release a patch, minor or major version. For 'release' command only.\n  --clean                       Do a clean build.  For 'build' command only.\n`)\n      return 0\n    }\n\n    if (this.args.version) {\n      this.log.info(`{$fullVersion}`)\n      return 0\n    }\n\n    const project = this.getProject()\n\n    switch (command.toLowerCase()) {\n      case 'start':\n        this.startAll(project)\n        break\n      case 'build':\n        this.buildAll(project)\n        break\n      case 'test':\n        this.testAll(project)\n        break\n      case 'release':\n        this.release(project)\n        break\n      default:\n        this.log.error('Use --help to see available commands')\n        return -1\n    }\n\n    return 0\n  }\n}\n"]}