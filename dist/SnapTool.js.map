{"version":3,"sources":["../src/SnapTool.js"],"names":["SnapTool","constructor","toolName","log","ensureCommands","cmds","Set","forEach","cmd","has","Error","add","getProject","filenames","ignore","realpath","dirNames","map","filename","path","dirname","pkgMap","Map","dirName","edges","rootPkg","pair","pkg","packageFilename","content","JSON","parse","encoding","error","process","cwd","dependencies","prefix","Object","entries","arr","startsWith","otherdirName","resolve","join","substring","length","push","pkgs","order","toposort","array","reverse","startAll","project","tempFile","tmp","fileSync","name","rootDir","preferActors","args","actors","script","get","scripts","tabDetails","actorNames","getOwnPropertyNames","filter","s","endsWith","title","color","start","isLibrary","keywords","Array","isArray","includes","hasOwnProperty","basename","detail","index","debug","info","testAll","test","info2","cleanAll","installAll","clean","updateAll","packages","pkgName","devDependencies","buildAll","install","build","deployAll","defaultUserHost","env","SNAP_DEPLOY_USER_HOST","userHost","prompt","readlineSync","question","chalk","gray","deploy","release","patch","minor","major","warning","incrFlag","tagName","tagDescription","npm","size","private","run","argv","options","boolean","alias","a","p","d","version","fullVersion","command","_","toLowerCase","help","slice"],"mappings":"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","file":"SnapTool.js","sourcesContent":["import { sync as globSync } from \"glob\"\nimport parseArgs from \"minimist\"\nimport { fullVersion } from \"./version\"\nimport util from \"util\"\nimport toposort from \"toposort\"\nimport {\n  readFileSync,\n  writeFileSync,\n  removeSync,\n  existsSync,\n  ensureDirSync,\n} from \"fs-extra\"\nimport path from \"path\"\nimport process from \"process\"\nimport { execSync } from \"child_process\"\nimport tmp from \"tmp\"\nimport { sync as commandExistsSync } from \"command-exists\"\nimport readlineSync from \"readline-sync\"\nimport chalk from \"chalk\"\n\nexport class SnapTool {\n  constructor(toolName, log) {\n    this.toolName = toolName\n    this.log = log\n  }\n\n  ensureCommands(cmds) {\n    this.cmds = this.cmds || new Set()\n\n    cmds.forEach((cmd) => {\n      if (!this.cmds.has(cmd) && !commandExistsSync(cmd)) {\n        throw new Error(`Command '${cmd}' does not exist.  Please install it.`)\n      } else {\n        this.cmds.add(cmd)\n      }\n    })\n  }\n\n  getProject() {\n    if (!existsSync(\"package.json\")) {\n      throw new Error(\n        \"The current directory does not contain a package.json file\"\n      )\n    }\n\n    const filenames = globSync(\"**/package.json\", {\n      ignore: [\"**/node_modules/**\", \"**/scratch/**\"],\n      realpath: true,\n    })\n    const dirNames = filenames.map((filename) => path.dirname(filename))\n    const pkgMap = new Map(dirNames.map((dirName) => [dirName, {}]))\n    let edges = []\n    let rootPkg = null\n\n    for (let pair of pkgMap) {\n      const [dirName, pkg] = pair\n      const packageFilename = dirName + \"/package.json\"\n      let content = null\n\n      try {\n        content = JSON.parse(\n          readFileSync(packageFilename, { encoding: \"utf8\" })\n        )\n      } catch (error) {\n        this.log.error(`Reading ${packageFilename}`)\n        throw error\n      }\n\n      pkg.content = content\n\n      if (dirName === process.cwd()) {\n        rootPkg = pkg\n      } else if (content.dependencies) {\n        const prefix = \"file:\"\n\n        Object.entries(content.dependencies).forEach((arr) => {\n          if (arr[1].startsWith(prefix)) {\n            const otherdirName = path.resolve(\n              path.join(dirName, arr[1].substring(prefix.length))\n            )\n\n            if (pkgMap.has(otherdirName)) {\n              edges.push([dirName, otherdirName])\n            }\n          }\n        })\n      }\n    }\n\n    return {\n      pkgs: pkgMap,\n      order: toposort.array(dirNames, edges).reverse(),\n      rootPkg,\n    }\n  }\n\n  startAll(project) {\n    this.ensureCommands([\"osascript\"])\n\n    const tempFile = tmp.fileSync().name\n    const rootDir = process.cwd()\n    const preferActors = !!this.args.actors\n\n    let script = `\n    tell application \"iTerm\"\n      tell (create window with default profile)\n    `\n    // Loop through package.json dirs\n    project.order.forEach((dirName) => {\n      const pkg = project.pkgs.get(dirName)\n\n      if (!pkg.content.scripts) {\n        return\n      }\n\n      let tabDetails = []\n\n      if (preferActors) {\n        const actorNames = Object.getOwnPropertyNames(\n          pkg.content.scripts\n        ).filter((s) => s.startsWith(\"actor:\") && !s.endsWith(\":debug\"))\n\n        if (actorNames.length > 0) {\n          tabDetails = actorNames.map((name) => ({\n            name,\n            title: name.substring(\"actor:\".length),\n            color: \"255 198 0\",\n          }))\n        }\n      }\n\n      if (tabDetails.length === 0) {\n        if (!pkg.content.scripts.start) {\n          return\n        }\n\n        const isLibrary =\n          pkg.content.keywords &&\n          ((Array.isArray(pkg.content.keywords) &&\n            pkg.content.keywords.includes(\"library\")) ||\n            pkg.content.keywords.hasOwnProperty(\"library\"))\n\n        tabDetails = [\n          {\n            name: \"start\",\n            title: path.basename(dirName),\n            color: isLibrary ? \"0 255 0\" : \"0 198 255\",\n          },\n        ]\n      }\n\n      tabDetails.forEach((detail, index) => {\n        if (index == 0) {\n          script += `\n          tell current session of current tab\n          write text \"cd ${dirName}; title ${detail.title}; tab-color ${\n            detail.color\n          }; npm run ${detail.name}\"\n          end tell\n          `\n        } else {\n          script += `\n          set newTab to (create tab with default profile)\n          tell newTab\n          tell current session of newTab\n          write text \"cd ${dirName}; title ${detail.title}; tab-color ${\n            detail.color\n          }; npm run ${detail.name}\"\n          end tell\n          end tell\n          `\n        }\n      })\n    })\n    script += `\n      end tell\n    end tell\n    `\n\n    writeFileSync(tempFile, script)\n\n    if (this.args.debug) {\n      this.log.info(script)\n    }\n\n    execSync(`osascript < ${tempFile}`)\n  }\n\n  testAll(project) {\n    this.ensureCommands([\"npm\"])\n    project.order.forEach((dirName, index) => {\n      const pkg = project.pkgs.get(dirName)\n\n      if (pkg.content.scripts && pkg.content.scripts.test) {\n        this.log.info2(`Testing '${path.basename(dirName)}'...`)\n        execSync(`npm test`, { cwd: dirName })\n      }\n    })\n  }\n\n  cleanAll(project) {\n    this.ensureCommands([\"npm\"])\n\n    project.order.forEach((dirName, index) => {\n      const name = path.basename(dirName)\n\n      this.log.info2(`Cleaning '${name}'...`)\n      removeSync(path.join(dirName, \"node_modules\"))\n      removeSync(path.join(dirName, \"package-lock.json\"))\n      removeSync(path.join(dirName, \"dist\"))\n      removeSync(path.join(dirName, \"build\"))\n    })\n  }\n\n  installAll(project) {\n    this.ensureCommands([\"npm\"])\n\n    if (this.args.clean) {\n      this.cleanAll(project)\n    }\n\n    project.order.forEach((dirName, index) => {\n      const pkg = project.pkgs.get(dirName)\n      const name = path.basename(dirName)\n\n      this.log.info2(`Installing modules in '${name}'...`)\n      execSync(`npm install`, { cwd: dirName })\n    })\n  }\n\n  updateAll(project) {\n    this.ensureCommands([\"npm\"])\n\n    project.order.forEach((dirName, index) => {\n      const pkg = project.pkgs.get(dirName)\n      const name = path.basename(dirName)\n\n      this.args.packages.forEach((pkgName) => {\n        if (\n          (pkg.content.dependencies && pkg.content.dependencies[pkgName]) ||\n          (pkg.content.devDependencies && pkg.content.devDependencies[pkgName])\n        ) {\n          this.log.info2(`Update '${pkgName}' in '${name}'...`)\n          execSync(`npm update ${pkgName}`, { cwd: dirName })\n        }\n      })\n    })\n  }\n\n  buildAll(project) {\n    this.ensureCommands([\"npm\"])\n\n    if (this.args.install) {\n      this.installAll(project)\n    }\n\n    project.order.forEach((dirName, index) => {\n      const pkg = project.pkgs.get(dirName)\n      const name = path.basename(dirName)\n\n      if (pkg.content.scripts && pkg.content.scripts.build) {\n        this.log.info2(`Building '${name}'...`)\n        execSync(\"npm run build\", { cwd: dirName })\n      }\n    })\n  }\n\n  deployAll(project) {\n    this.ensureCommands([\"npm\"])\n\n    let defaultUserHost = process.env.SNAP_DEPLOY_USER_HOST || \"\"\n    let userHost = defaultUserHost\n\n    if (!userHost || this.args.prompt) {\n      userHost =\n        readlineSync.question(\n          \"Deploy as user@host? \" + chalk.gray(`[${defaultUserHost}]`) + \" \"\n        ) || defaultUserHost\n    }\n\n    if (!userHost || !/.+@.+/i.test(userHost)) {\n      this.log.error(\"Deployment user@host must be specified.\")\n      return\n    }\n\n    project.order.forEach((dirName, index) => {\n      const pkg = project.pkgs.get(dirName)\n      const name = path.basename(dirName)\n\n      if (pkg.content.scripts && pkg.content.scripts.deploy) {\n        this.log.info2(`Deploying '${name}'...`)\n        execSync(\"npm run deploy\", {\n          cwd: dirName,\n          env: {\n            ...process.env,\n            SNAP_DEPLOY_USER_HOST: userHost,\n          },\n        })\n      }\n    })\n  }\n\n  release(project) {\n    this.ensureCommands([\"stampver\", \"git\", \"npx\", \"npm\"])\n\n    if (!this.args.patch && !this.args.minor && !this.args.major) {\n      this.log.warning(\n        `Major, minor or patch number must be incremented for release`\n      )\n      return\n    }\n\n    this.log.info2(\"Checking for Uncommitted Changes...\")\n    try {\n      execSync(\"git diff-index --quiet HEAD --\")\n    } catch (error) {\n      throw new Error(\n        \"There are uncomitted changes - commit or stash them and try again\"\n      )\n    }\n\n    this.log.info2(\"Pulling...\")\n    execSync(\"git pull\")\n\n    this.log.info2(\"Updating Version...\")\n    ensureDirSync(\"scratch\")\n\n    const incrFlag = this.args.patch\n      ? \"-i patch\"\n      : this.args.minor\n        ? \"-i minor\"\n        : this.args.major\n          ? \"-i major\"\n          : \"\"\n\n    execSync(`npx stampver ${incrFlag} -u -s`)\n    const tagName = readFileSync(\"scratch/version.tag.txt\")\n    const tagDescription = readFileSync(\"scratch/version.desc.txt\")\n\n    try {\n      this.log.info2(\"Building...\")\n      this.buildAll(project)\n      this.log.info2(\"Testing...\")\n      this.testAll(project)\n\n      this.log.info2(\"Committing Version Changes...\")\n      execSync(\"git add :/\")\n\n      if (this.args.patch || this.args.minor || this.args.major) {\n        this.log.info2(\"Tagging...\")\n        execSync(`git tag -a ${tagName} -m '${tagDescription}'`)\n      }\n\n      execSync(`git commit -m '${tagDescription}'`)\n    } catch (error) {\n      // Roll back version changes if anything went wrong\n      execSync(\"git checkout -- .\")\n      return\n    }\n\n    this.log.info2(\"Pushing to Git...\")\n    execSync(\"git push --follow-tags\")\n\n    if (\n      this.args.npm &&\n      project.pkgs.size >= 1 &&\n      !project.rootPkg.content.private\n    ) {\n      this.log.info2(\"Publishing to NPM...\")\n      execSync(\"npm publish\")\n    }\n  }\n\n  async run(argv) {\n    const options = {\n      boolean: [\n        \"help\",\n        \"version\",\n        \"patch\",\n        \"minor\",\n        \"major\",\n        \"clean\",\n        \"install\",\n        \"actors\",\n        \"npm\",\n        \"prompt\",\n        \"debug\",\n      ],\n      alias: {\n        a: \"actors\",\n        p: \"prompt\",\n        d: \"debug\",\n      },\n    }\n    this.args = parseArgs(argv, options)\n\n    if (this.args.version) {\n      this.log.info(`${fullVersion}`)\n      return 0\n    }\n\n    const project = this.getProject()\n    let command = this.args._[0]\n\n    command = command ? command.toLowerCase() : \"help\"\n\n    switch (command) {\n      case \"start\":\n        if (this.args.help) {\n          this.log.info(`Usage: ${this.toolName} start [options]\n\nDescription:\n\nRecursively runs 'npm start' in all directories containing 'package.json' except 'node_modules/**'.\n\nOptions:\n  --actors, -a    If one or more 'actor:*' scripts are found in the package.json,\n                  run those instead of the 'start' script, if it exists.\n`)\n          return 0\n        }\n        this.startAll(project)\n        break\n\n      case \"build\":\n        if (this.args.help) {\n          this.log.info(`Usage: ${this.toolName} build\n\nDescription:\n\nRecursively runs 'npm run build' in all directories containing 'package.json' except 'node_modules/**'.\n\nOptions:\n  --install       Recursively runs 'npm install' before building\n  --clean         If '--install' is specified, does a 'clean' first\n`)\n          return 0\n        }\n        this.buildAll(project)\n        break\n\n      case \"deploy\":\n        if (this.args.help) {\n          this.log.info(`Usage: ${this.toolName} deploy\n\nDescription:\n\nRecursively runs 'npm run deploy' in all directories containing 'package.json' except 'node_modules/**'.\nYou can set default values for the deployment user and host by setting the environment variable\nSNAP_DEPLOY_USER_HOST, e.g. user@host\n\nOptions:\n  --prompt, -p     Prompt for user/host even if the environment variable is set\n`)\n          return 0\n        }\n        this.deployAll(project)\n        break\n\n      case \"test\":\n        if (this.args.help) {\n          this.log.info(`Usage: ${this.toolName} test\n\nDescription:\n\nRecursively runs 'npm test' in all directories containing 'package.json' except 'node_modules/**'.\n`)\n          return 0\n        }\n        this.testAll(project)\n        break\n\n      case \"release\":\n        if (this.args.help) {\n          this.log.info(`Usage: ${this.toolName} release [options]\n\nDescription:\n\nIncrement version information with 'stampver', runs 'snap build', 'snap test',\ntags local Git repo, pushes changes then optionally releases to NPM.\n\nOptions:\n  --major       Release major version\n  --minor       Release minor version\n  --patch       Release a patch\n  --npm         Push a non-private build to NPM (http://npmjs.org)\n`)\n          return 0\n        }\n        this.release(project)\n        break\n\n      case \"clean\":\n        if (this.args.help) {\n          this.log.info(`Usage: ${this.toolName} clean\n\nDescription:\n\nRecursively deletes all 'dist' and 'node_modules' directories, and 'package-lock.json' files.\n`)\n          return 0\n        }\n        this.cleanAll(project)\n        break\n\n      case \"install\":\n        if (this.args.help) {\n          this.log.info(`Usage: ${this.toolName} install\n\nDescription:\n\nRecursively runs 'npm install' in all directories containing 'package.json' except 'node_modules/**'.\n`)\n          return 0\n        }\n        this.installAll(project)\n        break\n\n      case \"update\":\n        if (this.args.help) {\n          this.log.info(`Usage: ${this.toolName} update\n\nDescription:\n\nRecursively runs 'npm update' in all directories containing 'package.json' except 'node_modules/**'.\n`)\n          return 0\n        }\n        this.args.packages = this.args._.slice(1)\n        this.updateAll(project)\n        break\n\n      case \"help\":\n      default:\n        this.log.info(`\nUsage: ${this.toolName} <cmd> [options]\n\nCommands:\n  start       Run 'npm start' for all projects in new terminal tabs.\n              Requires iTerm2 (https://www.iterm2.com/)\n  build       Run 'npm run build' for all projects\n  deploy      Run 'npm run deploy' for all projects\n  test        Run 'npm test' for all projects\n  update      Run 'npm update <pkg>...' for all projects\n  install     Run 'npm install' for all projects\n  clean       Remove 'node_modules' and distribution files for all packages\n  release     Increment version, build, test, tag and release\n\nGlobal Options:\n  --help                        Shows this help.\n  --version                     Shows the tool version.\n`)\n        return 0\n    }\n\n    return 0\n  }\n}\n"]}